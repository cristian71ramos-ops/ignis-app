<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0c10">
<title>IGNIS</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0c10;
  --surface: #111318;
  --card: #181b23;
  --border: #242830;
  --border2: #2e3340;
  --ok: #00e676;
  --warn: #ffab00;
  --danger: #ff3d3d;
  --blue: #448aff;
  --text: #e8ecf5;
  --muted: #5a6070;
  --muted2: #8890a4;
  --font-d: 'Rajdhani', sans-serif;
  --font-m: 'DM Mono', monospace;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background: var(--bg);}
body{font-family:var(--font-d);color:var(--text);display:flex;flex-direction:column;max-width:480px;margin:0 auto;position:relative;}

/* ── SCREENS ── */
.screen{display:none;flex-direction:column;height:100%;}
.screen.active{display:flex;}

/* ══════════════════════════════════
   HOME SCREEN
══════════════════════════════════ */
#homeScreen{
  background: var(--bg);
  background-image: radial-gradient(ellipse 70% 40% at 50% 0%, rgba(0,230,118,0.07) 0%, transparent 60%);
  align-items: center; justify-content: center; padding: 30px 24px;
  gap: 0;
}
.home-logo-wrap{
  display:flex;flex-direction:column;align-items:center;margin-bottom:36px;cursor:pointer;
}
.home-logo-img{
  width:90px;height:90px;border-radius:22px;object-fit:cover;
  border:2px solid var(--border2);
  background:var(--card);display:flex;align-items:center;justify-content:center;
  font-size:40px;overflow:hidden;
}
.home-logo-img img{width:100%;height:100%;object-fit:cover;border-radius:20px;}
.home-app-name{
  font-size:28px;font-weight:700;letter-spacing:2px;margin-top:14px;
  color:var(--text);text-align:center;
}
.home-app-name span{color:var(--ok);}
.home-tagline{font-size:12px;color:var(--muted);font-family:var(--font-m);letter-spacing:1px;margin-top:4px;}
.home-edit-hint{font-size:10px;color:var(--muted);margin-top:6px;opacity:0.6;}

.home-btn{
  width:100%;padding:22px 20px;border-radius:18px;border:1px solid var(--border2);
  background:var(--card);cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;gap:16px;margin-bottom:14px;
  position:relative;overflow:hidden;
}
.home-btn::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,transparent 60%,rgba(255,255,255,0.03));
}
.home-btn:hover{transform:translateY(-2px);border-color:var(--ok);}
.home-btn:active{transform:scale(0.98);}
.home-btn-icon{
  width:52px;height:52px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;
}
.home-btn-text{text-align:left;}
.home-btn-title{font-size:19px;font-weight:700;letter-spacing:0.5px;}
.home-btn-sub{font-size:11px;color:var(--muted);margin-top:3px;font-family:var(--font-m);}
.home-btn-arrow{margin-left:auto;font-size:20px;color:var(--muted);flex-shrink:0;}

/* ── TOPBAR ── */
.topbar{
  display:flex;align-items:center;gap:12px;
  padding:14px 16px 10px;border-bottom:1px solid var(--border);
  flex-shrink:0;background: var(--bg);
}
.btn-back{
  width:36px;height:36px;border-radius:10px;
  border:1px solid var(--border2);background:var(--card);
  color:var(--muted2);font-size:22px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.18s;flex-shrink:0;
}
.btn-back:hover{border-color:var(--ok);color:var(--ok);}
.topbar-title{font-size:18px;font-weight:700;letter-spacing:0.5px;flex:1;}
.topbar-sub{font-size:11px;color:var(--muted);font-family:var(--font-m);}
.btn-icon{
  width:36px;height:36px;border-radius:10px;border:1px solid var(--border2);
  background:var(--card);color:var(--muted2);font-size:15px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.18s;
}
.btn-icon:hover{border-color:var(--ok);color:var(--ok);}

/* ── TABS ── */
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;background: var(--bg);}
.tab-btn{
  flex:1;padding:10px 0;font-size:13px;font-weight:600;
  font-family:var(--font-d);letter-spacing:0.5px;
  color:var(--muted);background:none;border:none;
  border-bottom:2px solid transparent;cursor:pointer;transition:all 0.18s;
}
.tab-btn.active{color:var(--ok);border-bottom-color:var(--ok);}

/* ── SCROLL ── */
.scroll{flex:1;overflow-y:auto;padding:14px 14px 90px;}
.scroll::-webkit-scrollbar{width:3px;}
.scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* ── VIEWS ── */
.view{display:none;}
.view.active{display:block;}

/* ══════════════════════════════════
   CALIBRATION MODULE
══════════════════════════════════ */
.summary-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.sum-box{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;}
.sum-val{font-size:22px;font-weight:700;font-family:var(--font-m);}
.sum-lbl{font-size:10px;color:var(--muted);margin-top:2px;letter-spacing:0.5px;}

.zone-label{font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px 2px;}
.zone-label:first-child{margin-top:0;}
.burner-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:13px 15px;margin-bottom:8px;
  display:flex;align-items:center;gap:12px;
  cursor:pointer;transition:all 0.18s;position:relative;overflow:hidden;
}
.burner-card::before{
  content:'';position:absolute;left:0;top:0;
  width:3px;height:100%;border-radius:2px 0 0 2px;
  background:var(--bc,var(--border));transition:background 0.3s;
}
.burner-card:hover{border-color:var(--border2);transform:translateX(2px);}
.burner-id{font-size:15px;font-weight:700;font-family:var(--font-m);}
.burner-meta{font-size:11px;color:var(--muted);margin-top:2px;}
.burner-values{font-size:11px;color:var(--muted2);margin-top:3px;font-family:var(--font-m);}
.burner-status{
  margin-left:auto;font-size:12px;font-weight:600;
  padding:3px 10px;border-radius:20px;white-space:nowrap;
}
.s-ok{background:rgba(0,230,118,0.12);color:var(--ok);}
.s-warn{background:rgba(255,171,0,0.12);color:var(--warn);}
.s-danger{background:rgba(255,61,61,0.12);color:var(--danger);}
.s-pending{background:rgba(90,96,112,0.1);color:var(--muted);}

/* form */
.form-header{display:flex;align-items:center;gap:12px;margin-bottom:18px;}
.form-title{font-size:20px;font-weight:700;}
.form-subtitle{font-size:12px;color:var(--muted);margin-top:1px;font-family:var(--font-m);}
.field-group{margin-bottom:14px;}
.field-label{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--muted2);margin-bottom:7px;display:block;}
.field-row{display:flex;gap:10px;}
.field-wrap{flex:1;position:relative;}
.field-unit{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--muted);font-family:var(--font-m);pointer-events:none;}
input[type="number"],input[type="text"],input[type="email"],select,input[type="date"]{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:10px;padding:12px 42px 12px 14px;
  font-size:16px;font-family:var(--font-m);font-weight:500;
  color:var(--text);outline:none;transition:border-color 0.18s;
  -moz-appearance:textfield;appearance:textfield;
}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;}
input[type="number"]:focus,input[type="text"]:focus,input[type="email"]:focus,select:focus,input[type="date"]:focus{border-color:var(--ok);}
select{padding-right:14px;font-size:14px;}
input[type="date"]{padding-right:14px;}
input.error-field{border-color:var(--danger)!important;background:rgba(255,61,61,0.05);}

/* validation toast */
.val-toast{
  background:rgba(255,61,61,0.12);border:1px solid rgba(255,61,61,0.3);
  border-radius:10px;padding:11px 14px;margin-bottom:12px;
  font-size:12px;color:var(--danger);font-family:var(--font-m);line-height:1.5;
  display:none;
}
.val-toast.show{display:block;}

/* result */
.result-panel{
  background:var(--card);border:1px solid var(--border2);
  border-radius:14px;padding:16px;margin-bottom:14px;
  opacity:0;transform:translateY(8px);
  transition:all 0.3s ease;pointer-events:none;
}
.result-panel.visible{opacity:1;transform:translateY(0);pointer-events:all;}
.result-diag{
  text-align:center;padding:12px;border-radius:10px;
  font-size:18px;font-weight:700;letter-spacing:1px;
  margin-bottom:14px;border:1px solid transparent;
}
.diag-ok{background:rgba(0,230,118,0.1);border-color:rgba(0,230,118,0.3);color:var(--ok);}
.diag-stoic{background:rgba(68,138,255,0.1);border-color:rgba(68,138,255,0.3);color:var(--blue);}
.diag-warn{background:rgba(255,171,0,0.1);border-color:rgba(255,171,0,0.3);color:var(--warn);}
.diag-danger{background:rgba(255,61,61,0.1);border-color:rgba(255,61,61,0.3);color:var(--danger);}
.diag-excess{background:rgba(255,100,0,0.1);border-color:rgba(255,100,0,0.3);color:#ff6400;}
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.result-item{background:var(--surface);border-radius:8px;padding:10px;}
.ri-label{font-size:10px;color:var(--muted);letter-spacing:0.5px;text-transform:uppercase;}
.ri-val{font-size:18px;font-weight:700;font-family:var(--font-m);margin-top:3px;}
.ri-unit{font-size:10px;color:var(--muted2);font-family:var(--font-m);}
.gauge-wrap{grid-column:1/-1;}
.gauge-label-row{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:5px;}
.gauge-track{height:8px;background:var(--border);border-radius:4px;overflow:hidden;position:relative;}
.gauge-ok-zone{position:absolute;left:6%;width:44%;height:100%;background:rgba(0,230,118,0.15);border-radius:2px;}
.gauge-fill{height:100%;border-radius:4px;transition:width 0.5s cubic-bezier(.4,0,.2,1),background 0.3s;position:relative;z-index:1;}

/* buttons */
.btn-primary{
  width:100%;padding:15px;border-radius:12px;border:none;
  background:var(--ok);color:#0a0c10;
  font-size:15px;font-weight:700;font-family:var(--font-d);letter-spacing:1px;
  cursor:pointer;transition:all 0.18s;
}
.btn-primary:hover{background:#33ff8a;transform:translateY(-1px);}
.btn-primary:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;}
.btn-secondary{
  width:100%;padding:13px;border-radius:12px;
  border:1px solid var(--border2);background:transparent;
  color:var(--muted2);font-size:14px;font-weight:600;
  font-family:var(--font-d);letter-spacing:0.5px;
  cursor:pointer;transition:all 0.18s;margin-top:8px;
}
.btn-secondary:hover{border-color:var(--muted2);color:var(--text);}

/* hist */
.hist-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px 15px;margin-bottom:8px;}
.hist-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.hist-id{font-size:14px;font-weight:700;font-family:var(--font-m);}
.hist-time{font-size:10px;color:var(--muted);font-family:var(--font-m);}
.hist-vals{display:flex;gap:14px;font-size:11px;font-family:var(--font-m);color:var(--muted2);flex-wrap:wrap;}

/* fab */
.fab{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  max-width:452px;width:calc(100% - 28px);
  padding:15px 20px;border-radius:14px;border:none;
  background:linear-gradient(135deg,#00b894,#00e676);
  color:#0a0c10;font-size:15px;font-weight:700;
  font-family:var(--font-d);letter-spacing:1px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
  box-shadow:0 8px 32px rgba(0,230,118,0.3);transition:all 0.2s;z-index:100;
}
.fab:hover{transform:translateX(-50%) translateY(-2px);}
.fab.hidden{opacity:0;pointer-events:none;transform:translateX(-50%) translateY(10px);}
.fab-count{background:rgba(0,0,0,0.25);border-radius:20px;padding:1px 8px;font-size:12px;margin-left:4px;}

/* ══════════════════════════════════
   MAINTENANCE MODULE
══════════════════════════════════ */
.maint-burner-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:13px 15px;margin-bottom:8px;
  display:flex;align-items:center;gap:12px;cursor:pointer;
  transition:all 0.18s;position:relative;overflow:hidden;
}
.maint-burner-card::before{
  content:'';position:absolute;left:0;top:0;
  width:3px;height:100%;border-radius:2px 0 0 2px;
  background:var(--bc,var(--border));
}
.maint-burner-card:hover{border-color:var(--border2);transform:translateX(2px);}
.maint-progress{
  height:4px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden;
}
.maint-progress-fill{height:100%;background:linear-gradient(90deg,var(--ok),#00b894);border-radius:2px;transition:width 0.4s;}

/* checklist */
.checklist-item{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:14px 15px;margin-bottom:10px;
}
.ci-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.ci-num{
  width:26px;height:26px;border-radius:8px;
  background:var(--surface);border:1px solid var(--border2);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;font-family:var(--font-m);color:var(--muted2);flex-shrink:0;
}
.ci-title{font-size:14px;font-weight:700;flex:1;}
.ci-options{display:flex;gap:8px;margin-bottom:10px;}
.ci-opt{
  flex:1;padding:9px 6px;border-radius:10px;border:1px solid var(--border2);
  background:var(--surface);cursor:pointer;transition:all 0.18s;
  text-align:center;font-size:12px;font-weight:600;font-family:var(--font-d);
  color:var(--muted);letter-spacing:0.3px;
}
.ci-opt:hover{border-color:var(--border2);color:var(--text);}
.ci-opt.sel-ok{background:rgba(0,230,118,0.1);border-color:rgba(0,230,118,0.4);color:var(--ok);}
.ci-opt.sel-afectado{background:rgba(255,171,0,0.1);border-color:rgba(255,171,0,0.4);color:var(--warn);}
.ci-opt.sel-cambio{background:rgba(255,61,61,0.1);border-color:rgba(255,61,61,0.4);color:var(--danger);}

.ci-dates{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.ci-date-label{font-size:10px;color:var(--muted);margin-bottom:5px;letter-spacing:0.5px;text-transform:uppercase;}
.ci-date-label span{font-size:8px;}

/* stock table */
.stock-table-wrap{overflow-x:auto;margin-top:8px;}
.stock-table{width:100%;border-collapse:collapse;font-size:11px;font-family:var(--font-m);}
.stock-table th{text-align:left;color:var(--muted);padding:6px 8px;border-bottom:1px solid var(--border);font-weight:600;white-space:nowrap;}
.stock-table td{padding:6px 8px;border-bottom:1px solid var(--border);color:var(--muted2);}
.stock-table td:first-child{color:var(--text);}
.btn-add-stock{
  margin-top:10px;width:100%;padding:10px;border-radius:10px;
  border:1px dashed var(--border2);background:transparent;
  color:var(--muted);font-size:12px;font-family:var(--font-d);cursor:pointer;
  transition:all 0.18s;
}
.btn-add-stock:hover{border-color:var(--ok);color:var(--ok);}

/* maint fab */
.fab-maint{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  max-width:452px;width:calc(100% - 28px);
  padding:15px 20px;border-radius:14px;border:none;
  background:linear-gradient(135deg,#1a6fff,var(--blue));
  color:#fff;font-size:15px;font-weight:700;
  font-family:var(--font-d);letter-spacing:1px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
  box-shadow:0 8px 32px rgba(68,138,255,0.3);transition:all 0.2s;z-index:100;
}
.fab-maint:hover{transform:translateX(-50%) translateY(-2px);}
.fab-maint.hidden{opacity:0;pointer-events:none;}

/* ── MODAL ── */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.75);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:200;opacity:0;pointer-events:none;transition:opacity 0.2s;
}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:20px 20px 0 0;padding:24px 20px 36px;
  width:100%;max-width:480px;
  transform:translateY(30px);transition:transform 0.25s ease;
  max-height:90vh;overflow-y:auto;
}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-title{font-size:18px;font-weight:700;margin-bottom:6px;}
.modal-sub{font-size:12px;color:var(--muted);margin-bottom:18px;font-family:var(--font-m);}
.modal-field{margin-bottom:12px;}
.modal-field label{font-size:11px;color:var(--muted2);display:block;margin-bottom:5px;letter-spacing:0.5px;}
.modal-table{width:100%;border-collapse:collapse;font-size:11px;margin-bottom:14px;}
.modal-table th{text-align:left;color:var(--muted);padding:0 6px 8px;font-weight:600;font-family:var(--font-m);}
.modal-table td{padding:6px;border-top:1px solid var(--border);font-family:var(--font-m);color:var(--muted2);}
.modal-table td:first-child{color:var(--text);font-weight:600;}
.modal-table-wrap{max-height:200px;overflow-y:auto;margin-bottom:14px;}
.modal-table-wrap::-webkit-scrollbar{width:3px;}
.modal-table-wrap::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.logo-preview{
  width:80px;height:80px;border-radius:16px;border:2px dashed var(--border2);
  background:var(--card);display:flex;align-items:center;justify-content:center;
  font-size:32px;cursor:pointer;overflow:hidden;transition:border-color 0.18s;margin:0 auto 14px;
}
.logo-preview:hover{border-color:var(--ok);}
.logo-preview img{width:100%;height:100%;object-fit:cover;}

/* empty */
.empty{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-icon{font-size:40px;margin-bottom:12px;}
.empty-text{font-size:14px;}

@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.anim{animation:fadeIn 0.25s ease both;}

/* ── LOCK SCREEN ── */
#lockScreen{
  background: var(--bg);
  background-image: 
    linear-gradient(to bottom, rgba(10,12,16,0.1) 0%, rgba(10,12,16,0.5) 60%, rgba(10,12,16,0.88) 100%),
    url('data:image/jpeg;base64,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');
  background-size: cover, cover;
  background-position: center, center;
  background-repeat: no-repeat, no-repeat;
  min-height: 100vh;
  width: 100%;
  align-items:center;justify-content:flex-end;padding:30px 24px 80px;
  flex-direction:column;
}
.lock-wrap{width:80%;max-width:260px;text-align:center;}
.lock-input{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:12px;padding:15px 18px;margin-bottom:0;
  font-size:20px;font-family:var(--font-m);color:var(--text);
  outline:none;transition:border-color 0.18s;letter-spacing:4px;text-align:center;
}
.lock-input:focus{border-color:var(--ok);}
.lock-input.shake{animation:shake 0.35s ease;border-color:var(--danger);}
.lock-error{font-size:12px;color:var(--danger);font-family:var(--font-m);min-height:18px;margin-bottom:8px;}
.lock-hint{font-size:10px;color:rgba(255,255,255,0.6);margin:10px 0 10px;font-family:var(--font-m);line-height:1.6;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
@keyframes scanMove{0%{top:10px;opacity:1;}100%{top:200px;opacity:0.3;}}
</style>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-ZE_noIMTttf_s_9jQ0U8elfDZuLf88o",
      authDomain: "ignis-ab6b6.firebaseapp.com",
      projectId: "ignis-ab6b6",
      storageBucket: "ignis-ab6b6.firebasestorage.app",
      messagingSenderId: "522763402694",
      appId: "1:522763402694:web:2bd84d65e27e5f2744c6c7"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db    = getFirestore(fbApp);

    window._fbDb      = db;
    window._fbDoc     = doc;
    window._fbSetDoc  = setDoc;
    window._fbGetDoc  = getDoc;
    window._fbReady   = true;

    // Escuchar cambios en tiempo real
    onSnapshot(doc(db, 'ignis', 'datos'), (snap) => {
      if (!snap.exists()) return;
      const data = snap.data();
      if (data._ts === window._lastSaveTs) return;
      if (data.burners)     burners     = data.burners;
      if (data.readings)    readings    = data.readings;
      if (data.history)     history     = data.history;
      if (data.maintData)   maintData   = data.maintData;
      if (data.appConfig)   appConfig   = data.appConfig;
      if (data.inventory)   inventory   = data.inventory;
      if (data.maintPhotos) maintPhotos = data.maintPhotos;
      console.log('🔄 Datos sincronizados desde Firebase');
      try { if(typeof renderCalibList==='function') renderCalibList(); } catch(e){}
      try { if(typeof renderInventory==='function' && currentInventoryFilter) renderInventory(); } catch(e){}
    });

    // Cargar datos al iniciar
    window.addEventListener('load', async () => {
      try {
        const snap = await getDoc(doc(db, 'ignis', 'datos'));
        if (snap.exists()) {
          const data = snap.data();
          if (data.burners)     { burners     = data.burners;     localStorage.setItem('cb_burners',  JSON.stringify(burners)); }
          if (data.readings)    { readings    = data.readings;    localStorage.setItem('cb_readings', JSON.stringify(readings)); }
          if (data.history)     { history     = data.history;     localStorage.setItem('cb_history',  JSON.stringify(history)); }
          if (data.maintData)   { maintData   = data.maintData;   localStorage.setItem('cb_maint',    JSON.stringify(maintData)); }
          if (data.appConfig)   { appConfig   = data.appConfig;   localStorage.setItem('cb_config',   JSON.stringify(appConfig)); }
          if (data.inventory)   { inventory   = data.inventory;   localStorage.setItem('cb_inventory',JSON.stringify(inventory)); }
          if (data.maintPhotos) { maintPhotos = data.maintPhotos; localStorage.setItem('cb_photos',   JSON.stringify(maintPhotos)); }
          console.log('☁️ Datos cargados desde Firebase');
        }
      } catch(e) { console.warn('Firebase load error:', e); }
    });
  </script>
</head>
<body>

<!-- ══════════════════════════
     LOCK SCREEN
══════════════════════════ -->
<div class="screen active" id="lockScreen">
  <div class="lock-wrap">
    <div class="lock-error" id="lockError"></div>
    <input class="lock-input" id="lockInput" type="password"
      placeholder="• • • • • •"
      onkeydown="if(event.key==='Enter') checkPassword()"
      autocomplete="off">
    <div class="lock-hint">
      Si no tenés la contraseña,<br>contactá al administrador de la app.
    </div>
    <button class="btn-primary" onclick="checkPassword()">INGRESAR</button>
  </div>
</div>

<!-- ══════════════════════════
     HOME SCREEN
══════════════════════════ -->

<div class="screen" id="registerScreen">
  <div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;background:var(--bg);">
    <div style="width:100%;max-width:400px;">
      <div style="text-align:center;margin-bottom:32px;">
        <div style="font-size:48px;margin-bottom:12px;">👤</div>
        <div style="font-size:22px;font-weight:800;color:var(--text);font-family:var(--font-d);letter-spacing:1px;">REGÍSTRESE</div>
        <div style="font-size:13px;color:var(--muted);font-family:var(--font-m);margin-top:6px;">Sus datos quedan guardados en este dispositivo</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div>
          <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);margin-bottom:6px;letter-spacing:1px;">NOMBRE</div>
          <input id="regNombre" type="text" placeholder="Ingrese su nombre" autocomplete="given-name"
            style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);font-family:var(--font-m);outline:none;box-sizing:border-box;"
            onkeydown="if(event.key==='Enter')document.getElementById('regApellido').focus()">
        </div>
        <div>
          <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);margin-bottom:6px;letter-spacing:1px;">APELLIDO</div>
          <input id="regApellido" type="text" placeholder="Ingrese su apellido" autocomplete="family-name"
            style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);font-family:var(--font-m);outline:none;box-sizing:border-box;"
            onkeydown="if(event.key==='Enter')document.getElementById('regEmpresa').focus()">
        </div>
        <div>
          <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);margin-bottom:6px;letter-spacing:1px;">EMPRESA</div>
          <input id="regEmpresa" type="text" placeholder="Ingrese su empresa" autocomplete="organization"
            style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:14px 16px;font-size:15px;color:var(--text);font-family:var(--font-m);outline:none;box-sizing:border-box;"
            onkeydown="if(event.key==='Enter')saveRegister()">
        </div>
        <div id="regError" style="color:var(--danger);font-size:12px;font-family:var(--font-m);text-align:center;min-height:16px;"></div>
        <button class="btn-primary" onclick="saveRegister()" style="margin-top:8px;letter-spacing:2px;">CONTINUAR</button>
      </div>
    </div>
  </div>
</div>

<div class="screen" id="homeScreen">
  <div class="home-logo-wrap" onclick="openSettings()">
    <div class="home-logo-img" id="homeLogo">🔥</div>
    <div class="home-app-name" id="homeAppName">IGNIS</div>
    <div class="home-tagline" id="homeTagline">ECLIPSE TJ · Sistema de Gestión</div>
    <div class="home-edit-hint">toca para personalizar</div>
  </div>

  <div style="width:100%">
    <div class="home-btn" onclick="goTo('calibScreen')">
      <div class="home-btn-icon" style="background:rgba(0,230,118,0.1);">🔥</div>
      <div class="home-btn-text">
        <div class="home-btn-title">CALIBRACIÓN</div>
        <div class="home-btn-sub">Presiones · Diagnóstico · Informe</div>
      </div>
      <div class="home-btn-arrow">›</div>
    </div>
    <div class="home-btn" onclick="goTo('maintScreen')">
      <div class="home-btn-icon" style="background:rgba(68,138,255,0.1);">🔧</div>
      <div class="home-btn-text">
        <div class="home-btn-title">MANTENIMIENTO PREVENTIVO</div>
        <div class="home-btn-sub">Checklist · Fechas · Informe</div>
      </div>
      <div class="home-btn-arrow">›</div>
    </div>
    <div class="home-btn" onclick="goTo('stockScreen')">
      <div class="home-btn-icon" style="background:rgba(255,171,0,0.1);">📦</div>
      <div class="home-btn-text">
        <div class="home-btn-title">STOCK DE REPUESTOS</div>
        <div class="home-btn-sub">Piezas · Cantidad · Proveedor</div>
      </div>
      <div class="home-btn-arrow">›</div>
    </div>
    <div class="home-btn" onclick="goTo('scanScreen')">
      <div class="home-btn-icon" style="background:rgba(232,80,26,0.1);">📱</div>
      <div class="home-btn-text">
        <div class="home-btn-title">ESCANEAR QR</div>
        <div class="home-btn-sub">Ver historial del quemador</div>
      </div>
      <div class="home-btn-arrow">›</div>
    </div>
  </div>
</div>



<!-- ══════════════════════════
     SCANNER QR SCREEN
══════════════════════════ -->
<div class="screen" id="scanScreen">
  <div class="screen-header" style="padding:10px 16px;">
    <button class="btn-back" onclick="goTo('homeScreen')">‹</button>
    <div class="sh-text">
      <div class="sh-title">ESCANEAR QR</div>
      <div class="sh-sub">Apuntá al código del quemador</div>
    </div>
  </div>

  <div class="screen-body" style="padding:0;display:flex;flex-direction:column;gap:0;flex:1;">
    <div id="scannerContainer" style="flex:1;background:#000;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;">
      <video id="scannerVideo" playsinline autoplay muted style="width:100%;height:100%;object-fit:cover;"></video>
      <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;">
        <!-- Frame esquinas naranjas igual a mini app -->
        <div style="width:220px;height:220px;position:relative;">
          <div style="position:absolute;top:0;left:0;width:30px;height:30px;border-top:3px solid var(--warn);border-left:3px solid var(--warn);border-radius:4px 0 0 0;"></div>
          <div style="position:absolute;top:0;right:0;width:30px;height:30px;border-top:3px solid var(--warn);border-right:3px solid var(--warn);border-radius:0 4px 0 0;"></div>
          <div style="position:absolute;bottom:0;left:0;width:30px;height:30px;border-bottom:3px solid var(--warn);border-left:3px solid var(--warn);border-radius:0 0 0 4px;"></div>
          <div style="position:absolute;bottom:0;right:0;width:30px;height:30px;border-bottom:3px solid var(--warn);border-right:3px solid var(--warn);border-radius:0 0 4px 0;"></div>
          <div style="position:absolute;left:10px;right:10px;height:2px;background:linear-gradient(90deg,transparent,var(--warn),transparent);animation:scanMove 2s ease-in-out infinite;top:10px;"></div>
        </div>
        <div id="scannerStatus" style="background:rgba(0,0,0,0.75);color:#fff;padding:10px 24px;border-radius:20px;font-size:13px;font-family:var(--font-m);letter-spacing:1px;border:1px solid rgba(255,171,0,0.2);">
          Buscando QR...
        </div>
      </div>
    </div>
    <div style="padding:16px;background:var(--card);text-align:center;flex-shrink:0;">
      <button onclick="stopScanner();goTo('homeScreen')" style="padding:12px 32px;background:var(--danger);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;">
        CANCELAR
      </button>
    </div>
  </div>
</div>

<!-- ══════════════════════════
     BURNER INFO SCREEN
══════════════════════════ -->
<div class="screen" id="burnerInfoScreen">
  <div class="screen-header">
    <button class="btn-back" onclick="goTo('scanScreen')">‹</button>
    <div class="sh-text">
      <div class="sh-title" id="biTitle">Q-SEC-01</div>
      <div class="sh-sub" id="biSub">TJ 040 · Secado</div>
    </div>
    <button class="btn-icon" onclick="goTo('scanScreen')" style="margin-left:auto;">📱</button>
  </div>
  
  <div class="screen-body" id="biBody" style="padding:16px;gap:12px;">
    <!-- Contenido dinámico -->
  </div>
</div>
<!-- ══════════════════════════
     CALIBRATION SCREEN
══════════════════════════ -->
<div class="screen" id="calibScreen">
  <div class="topbar">
    <button class="btn-back" onclick="goTo('homeScreen')">‹</button>
    <div style="flex:1">
      <div class="topbar-title">CALIBRACIÓN</div>
      <div class="topbar-sub">ECLIPSE TJ</div>
    </div>
    <div class="btn-icon" onclick="generateCalibPDF()" title="Descargar PDF">📄</div>
    <div class="btn-icon" onclick="showAddBurnerSecure()" title="Agregar quemador">＋</div>
    <div class="btn-icon" onclick="clearCalibSecure()" title="Reiniciar mediciones" style="color:var(--warn);">↺</div>
  </div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchCalibTab('list')">QUEMADORES</button>
    <button class="tab-btn" onclick="switchCalibTab('history')">HISTORIAL</button>
  </div>
  <div class="scroll" id="calibScroll">
    <div class="view active" id="cv-list">
      <div class="summary-bar" id="summaryBar"></div>
      <div id="burnerList"></div>
    </div>
    <div class="view" id="cv-form">
      <div class="form-header">
        <button class="btn-back" onclick="backToCalibList()">‹</button>
        <div>
          <div class="form-title" id="formTitle">—</div>
          <div class="form-subtitle" id="formSub">—</div>
        </div>
      </div>
      <div class="val-toast" id="valToast"></div>
      <div class="field-group">
        <label class="field-label">Presiones Diferenciales</label>
        <div class="field-row">
          <div class="field-wrap">
            <input type="number" id="inp-aire" placeholder="0.0" step="0.1" min="0" oninput="calculate()">
            <span class="field-unit">ΔP Aire</span>
          </div>
          <div class="field-wrap">
            <input type="number" id="inp-gas" placeholder="0.0" step="0.1" min="0" oninput="calculate()">
            <span class="field-unit">ΔP Gas</span>
          </div>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px;font-family:var(--font-m);">Unidad: mbar · TAP A-C (aire) / TAP D-B (gas)</div>
      </div>
      <!-- DIAGNÓSTICO MANTENIMIENTO -->
      <div id="maintDiagPanel" style="background:var(--card);border-radius:12px;padding:12px 14px;margin-bottom:12px;border:1px solid var(--border2);">
        <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);margin-bottom:8px;letter-spacing:0.5px;">DIAGNÓSTICO MANTENIMIENTO</div>
        <div style="display:flex;gap:16px;">
          <div style="flex:1;">
            <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);margin-bottom:3px;">Boquilla</div>
            <div id="diag-boquilla" style="font-size:13px;font-weight:700;">—</div>
          </div>
          <div style="flex:1;">
            <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);margin-bottom:3px;">Cono de Retención</div>
            <div id="diag-cono" style="font-size:13px;font-weight:700;">—</div>
          </div>
        </div>
      </div>
      <div class="result-panel" id="resultPanel">
        <div class="result-diag" id="resultDiag">—</div>
        <div class="result-grid">
          <div class="result-item"><div class="ri-label">Potencia</div><div class="ri-val" id="res-pot">—</div><div class="ri-unit">BTU/h</div></div>
          <div class="result-item"><div class="ri-label">% Carga</div><div class="ri-val" id="res-carga">—</div><div class="ri-unit">del máx</div></div>
          <div class="result-item"><div class="ri-label">Flujo Aire</div><div class="ri-val" id="res-aire">—</div><div class="ri-unit">m³/h</div></div>
          <div class="result-item"><div class="ri-label">Flujo Gas</div><div class="ri-val" id="res-gas">—</div><div class="ri-unit">m³/h</div></div>
          <div class="result-item gauge-wrap">
            <div class="ri-label">Exceso de Aire</div>
            <div class="ri-val" id="res-exceso" style="margin-bottom:8px;">—</div>
            <div class="gauge-label-row"><span>0%</span><span>óptimo 3–25%</span><span>50%+</span></div>
            <div class="gauge-track"><div class="gauge-ok-zone"></div><div class="gauge-fill" id="gaugeFill" style="width:0%"></div></div>
          </div>
          <div class="result-item"><div class="ri-label">Consumo Gas</div><div class="ri-val" id="res-consumo">—</div><div class="ri-unit">m³/h</div></div>
        </div>
      </div>
      <button class="btn-primary" id="btnSave" onclick="saveReading()" disabled>GUARDAR MEDICIÓN</button>
      <button class="btn-secondary" onclick="backToCalibList()">CANCELAR</button>
      <div style="height:80px;"></div>
    </div>
    <div class="view" id="cv-history"><div id="historyList"></div></div>
  </div>
  <button class="fab hidden" id="fabSend" onclick="openEmailModal()">
    <span>✉</span> ENVIAR INFORME <span class="fab-count" id="fabCount">0</span>
  </button>
</div>

<!-- ══════════════════════════
     MAINTENANCE SCREEN
══════════════════════════ -->
<div class="screen" id="maintScreen">
  <div class="topbar">
    <button class="btn-back" onclick="goTo('homeScreen')">‹</button>
    <div style="flex:1">
      <div class="topbar-title">MANTENIMIENTO</div>
      <div class="topbar-sub">Checklist preventivo por quemador</div>
    </div>
    <div class="btn-icon" onclick="generateMaintPDF()" title="Descargar PDF">📄</div>
    <div class="btn-icon" onclick="openMaintEmailModal()" title="Enviar informe">✉</div>
  </div>
  <div class="scroll" id="maintScroll">
    <div id="maintView-list">
      <div id="maintBurnerList"></div>
    </div>
    <div id="maintView-form" style="display:none;">
      <div class="form-header" style="margin-bottom:14px;">
        <button class="btn-back" onclick="backToMaintList()">‹</button>
        <div style="flex:1">
          <div class="form-title" id="maintFormTitle">—</div>
          <div class="form-subtitle" id="maintFormSub">—</div>
        </div>
      </div>

      <!-- FOTO DEL QUEMADOR -->
      <div class="checklist-item" style="margin-bottom:12px;">
        <div class="ci-header" style="margin-bottom:12px;">
          <div class="ci-num">📷</div>
          <div class="ci-title">Foto del Quemador</div>
        </div>
        <input type="file" id="photoInput" accept="image/*" capture="environment"
          style="display:none" onchange="handlePhotoUpload(event)">
        <div id="photoPreviewWrap" style="display:none;margin-bottom:12px;position:relative;">
          <img id="photoPreview" style="width:100%;border-radius:12px;max-height:260px;object-fit:cover;display:block;">
          <button onclick="removePhoto()"
            style="position:absolute;top:10px;right:10px;width:32px;height:32px;
            border-radius:50%;background:rgba(0,0,0,0.65);border:none;color:#fff;
            font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;">✕</button>
          <div id="photoDate" style="font-size:11px;color:var(--muted);font-family:var(--font-m);margin-top:6px;text-align:right;"></div>
        </div>
        <div id="photoEmpty" style="display:flex;gap:10px;">
          <button onclick="document.getElementById('photoInput').click()"
            style="flex:1;padding:20px 14px;border-radius:14px;border:2px dashed var(--border2);
            background:transparent;color:var(--muted2);font-size:15px;font-weight:700;
            font-family:var(--font-d);cursor:pointer;transition:all 0.18s;letter-spacing:0.5px;"
            onmouseover="this.style.borderColor='var(--ok)';this.style.color='var(--ok)'"
            onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--muted2)'">
            📷<br><span style="font-size:11px;margin-top:4px;display:block;">SACAR FOTO</span>
          </button>
          <button onclick="document.getElementById('photoInput').setAttribute('capture','');document.getElementById('photoInput').click();setTimeout(()=>document.getElementById('photoInput').setAttribute('capture','environment'),500)"
            style="flex:1;padding:20px 14px;border-radius:14px;border:2px dashed var(--border2);
            background:transparent;color:var(--muted2);font-size:15px;font-weight:700;
            font-family:var(--font-d);cursor:pointer;transition:all 0.18s;letter-spacing:0.5px;"
            onmouseover="this.style.borderColor='var(--blue)';this.style.color='var(--blue)'"
            onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--muted2)'">
            🖼️<br><span style="font-size:11px;margin-top:4px;display:block;">GALERÍA</span>
          </button>
        </div>
      </div>

      <div id="checklistItems"></div>
      <div style="height:80px;"></div>
    </div>
  </div>
  <button class="fab-maint hidden" id="fabMaint" onclick="saveMaint()">
    💾 GUARDAR CHECKLIST
  </button>
  <button class="fab hidden" id="fabMaintSend" onclick="openMaintEmailModal()" style="background:linear-gradient(135deg,#1a6fff,var(--blue));box-shadow:0 8px 32px rgba(68,138,255,0.3);">
    <span>✉</span> ENVIAR INFORME MANTENIMIENTO
  </button>
</div>

<!-- ══════════════════════════
     STOCK SCREEN
══════════════════════════ -->
<div class="screen" id="stockScreen">
  <div class="topbar">
    <button class="btn-back" onclick="goTo('homeScreen')">‹</button>
    <div style="flex:1">
      <div class="topbar-title">GESTIÓN DE REPUESTOS</div>
      <div class="topbar-sub">Stock general · Piezas · Proveedores</div>
    </div>
    <div class="btn-icon" onclick="generateInventoryPDF()" title="Generar PDF" style="font-size:16px;">📄</div>
  </div>

  <!-- LOCK SCREEN para stock -->
  <div id="stockLock" class="scroll" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;padding:24px;">
    <div style="font-size:48px;margin-bottom:16px;">🔒</div>
    <div style="font-size:18px;font-weight:700;font-family:var(--font-d);color:var(--text);margin-bottom:6px;">STOCK RESTRINGIDO</div>
    <div style="font-size:12px;color:var(--muted);font-family:var(--font-m);margin-bottom:24px;text-align:center;">Ingresá la clave para acceder al inventario</div>
    <div style="width:100%;max-width:280px;">
      <input type="password" id="stockPassInput" placeholder="Clave de acceso"
        style="width:100%;background:var(--card);border:1.5px solid var(--border2);border-radius:12px;
        padding:14px 16px;font-size:18px;color:var(--text);font-family:var(--font-m);outline:none;
        text-align:center;letter-spacing:4px;margin-bottom:12px;"
        onkeydown="if(event.key==='Enter')checkStockPass()">
      <button class="btn-primary" onclick="checkStockPass()">INGRESAR</button>
    </div>
  </div>

  <!-- CONTENIDO STOCK (oculto hasta pasar clave) -->
  <div id="stockContent" style="display:none;height:100%;">
    <div class="tabs">
      <button class="tab-btn active" id="stab-list"  onclick="switchStockTab('list')">MI INVENTARIO</button>
      <button class="tab-btn"        id="stab-add"   onclick="switchStockTab('add')">＋ AGREGAR</button>
    </div>
    <div class="scroll" id="stockScroll">

      <!-- INVENTORY LIST -->
      <div id="sv-inventory" class="view active">
        <!-- Model filter -->
        <div style="display:flex;gap:8px;margin-bottom:14px;">
          <button class="ci-opt sel-ok" id="si015" onclick="filterInventory('TJ 015')" style="flex:1;">TJ 015</button>
          <button class="ci-opt"        id="si025" onclick="filterInventory('TJ 025')" style="flex:1;">TJ 025</button>
          <button class="ci-opt"        id="si040" onclick="filterInventory('TJ 040')" style="flex:1;">TJ 040</button>
          <button class="ci-opt"        id="si075" onclick="filterInventory('TJ 075')" style="flex:1;">TJ 075</button>
          <button class="ci-opt"        id="siGEN" onclick="filterInventory('TODOS')"  style="flex:1;">GENERAL</button>
        </div>
        <div id="inventoryList"></div>
      </div>

      <!-- ADD FORM -->
      <div id="sv-addform" class="view">

        <!-- MODELO -->
        <div class="field-group">
          <label class="field-label">MODELO</label>
          <select id="sModelSel" style="width:100%;padding:11px 14px;font-size:14px;background:var(--card);border:1px solid var(--border2);border-radius:10px;color:var(--text);">
            <option value="TJ 015">TJ 015</option>
            <option value="TJ 025">TJ 025</option>
            <option value="TJ 040">TJ 040</option>
            <option value="TJ 075">TJ 075</option>
            <option value="TODOS">GENERAL (Todos los modelos)</option>
          </select>
        </div>

        <!-- Nº PIEZA + DESCRIPCIÓN -->
        <div class="field-group"><label class="field-label">Nº DE PIEZA</label>
          <div class="field-wrap"><input type="text" id="sPartNum" placeholder="Ej: EC-1234"></div></div>
        <div class="field-group"><label class="field-label">DESCRIPCIÓN</label>
          <div class="field-wrap"><input type="text" id="sDesc" placeholder="Ej: Boquilla TJ 040"></div></div>

        <!-- CANTIDAD + MARCA -->
        <div class="field-row" style="gap:10px;margin-bottom:14px;">
          <div style="flex:1"><label class="field-label">CANTIDAD</label>
            <div class="field-wrap"><input type="number" id="sQty" placeholder="1" min="1" value="1"></div></div>
          <div style="flex:1"><label class="field-label">MARCA</label>
            <div class="field-wrap"><input type="text" id="sBrand" placeholder="ECLIPSE" value="ECLIPSE"></div></div>
        </div>

        <!-- PROVEEDOR -->
        <div class="field-group"><label class="field-label">PROVEEDOR</label>
          <div class="field-wrap"><input type="text" id="sSupplier" placeholder="Nombre del proveedor"></div></div>

        <!-- FOTO DEL REPUESTO -->
        <div class="field-group">
          <label class="field-label">FOTO DEL REPUESTO</label>
          <input type="file" id="stockPhotoInput" accept="image/*" style="display:none" onchange="handleStockPhoto(event)">

          <!-- Preview (oculto hasta que haya foto) -->
          <div id="stockPhotoPreview" style="display:none;position:relative;margin-bottom:8px;">
            <img id="stockPhotoImg" style="width:100%;height:160px;object-fit:cover;border-radius:12px;display:block;border:1px solid var(--border2);">
            <button onclick="removeStockPhoto()"
              style="position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:50%;
              background:rgba(0,0,0,0.65);border:none;color:#fff;font-size:15px;cursor:pointer;">✕</button>
          </div>

          <!-- Zona de carga (visible cuando no hay foto) -->
          <div id="stockPhotoEmpty" style="display:flex;gap:10px;">
            <button onclick="document.getElementById('stockPhotoInput').setAttribute('capture','environment');document.getElementById('stockPhotoInput').click()"
              style="flex:1;padding:18px 10px;border-radius:12px;border:2px dashed var(--border2);
              background:transparent;color:var(--muted2);font-size:13px;font-weight:700;
              font-family:var(--font-d);cursor:pointer;text-align:center;"
              onmouseover="this.style.borderColor='var(--ok)';this.style.color='var(--ok)'"
              onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--muted2)'">
              📷<br><span style="font-size:10px;margin-top:3px;display:block;">CÁMARA</span>
            </button>
            <button onclick="document.getElementById('stockPhotoInput').removeAttribute('capture');document.getElementById('stockPhotoInput').click()"
              style="flex:1;padding:18px 10px;border-radius:12px;border:2px dashed var(--border2);
              background:transparent;color:var(--muted2);font-size:13px;font-weight:700;
              font-family:var(--font-d);cursor:pointer;text-align:center;"
              onmouseover="this.style.borderColor='var(--blue)';this.style.color='var(--blue)'"
              onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--muted2)'">
              🖼️<br><span style="font-size:10px;margin-top:3px;display:block;">GALERÍA</span>
            </button>
          </div>
        </div>

        <button class="btn-primary" onclick="saveInventoryItem()" style="margin-bottom:8px;">GUARDAR</button>
        <button class="btn-secondary" onclick="switchStockTab('list')">CANCELAR</button>
      </div>

    </div>
  </div>
</div>

<!-- ══════════════════════════
     MODALS
══════════════════════════ -->

<!-- Email Modal -->
<div class="modal-overlay" id="emailModal">
  <div class="modal">
    <div class="modal-title">📋 Informe de Turno</div>
    <div class="modal-sub" id="modalSub"></div>
    <div class="modal-table-wrap">
      <table class="modal-table">
        <thead><tr><th>ID</th><th>Modelo</th><th>ΔPa</th><th>ΔPg</th><th>BTU/h</th><th>%Exc</th><th>Est.</th></tr></thead>
        <tbody id="modalTableBody"></tbody>
      </table>
    </div>
    <!-- Share info -->
    <div style="background:rgba(0,200,100,0.08);border:1px solid rgba(0,200,100,0.2);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:11px;color:var(--muted2);font-family:var(--font-m);line-height:1.8;">
      <div>📱 En el celular: abre el menú de compartir con el PDF ya adjunto</div>
      <div>💻 En PC: descarga el PDF para adjuntarlo manualmente</div>
    </div>
    <button id="shareCalibBtn" class="btn-primary" onclick="shareCalibPDF()" style="margin-bottom:8px;">📤 COMPARTIR PDF DE CALIBRACIÓN</button>
    <button class="btn-secondary" onclick="closeModal('emailModal')">CANCELAR</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-title">⚙️ Personalizar App</div>
    <div class="modal-sub">Logo, nombre y empresa</div>
    <div style="text-align:center;margin-bottom:16px;">
      <div class="logo-preview" id="logoPreview" onclick="document.getElementById('logoFileInput').click()">
        <span id="logoEmoji">🔥</span>
      </div>
      <input type="file" id="logoFileInput" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">
      <div style="font-size:11px;color:var(--muted);margin-top:6px;">Toca para subir tu logo</div>
    </div>
    <div class="modal-field"><label>NOMBRE DE LA APP</label><input type="text" id="settAppName" placeholder="IGNIS" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:16px;color:var(--text);font-family:var(--font-d);outline:none;"></div>
    <div class="modal-field"><label>SUBTÍTULO / EMPRESA</label><input type="text" id="settTagline" placeholder="ECLIPSE TJ · Sistema de Gestión" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;"></div>
    <div class="modal-field">
      <label>CAMBIAR CONTRASEÑA PRINCIPAL</label>
      <input type="password" id="settPassNew" placeholder="Nueva contraseña" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;margin-bottom:8px;">
      <input type="password" id="settPassConfirm" placeholder="Repetir contraseña" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;">
      <div style="font-size:10px;color:var(--muted);margin-top:5px;font-family:var(--font-m);">Dejá vacío para no cambiar la contraseña actual</div>
    </div>
    <div class="modal-field">
      <label>CAMBIAR CLAVE DE STOCK</label>
      <input type="password" id="settStockPass" placeholder="Nueva clave de stock" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;">
      <label style="margin-top:12px;display:block;">CAMBIAR CLAVE ADMINISTRADOR</label>
      <input type="password" id="settAdminPass" placeholder="Nueva clave de administrador" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;">
      <div style="font-size:10px;color:var(--muted);margin-top:5px;font-family:var(--font-m);">Dejá vacío para no cambiar (actual: ****)</div>
    </div>
    <button class="btn-primary" onclick="saveSettings()" style="margin-bottom:8px;">GUARDAR</button>
    <button class="btn-secondary" onclick="closeModal('settingsModal')">CANCELAR</button>
  </div>
</div>

<!-- Maintenance Email Modal -->
<div class="modal-overlay" id="maintEmailModal">
  <div class="modal">
    <div class="modal-title">🔧 Informe de Mantenimiento</div>
    <div class="modal-sub" id="maintModalSub"></div>
    <div class="modal-table-wrap">
      <table class="modal-table">
        <thead><tr><th>ID</th><th>Modelo</th><th>Ítem</th><th>Estado</th><th>F. Inst.</th><th>F. Cambio</th></tr></thead>
        <tbody id="maintModalTableBody"></tbody>
      </table>
    </div>
    <div style="background:rgba(0,200,100,0.08);border:1px solid rgba(0,200,100,0.2);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:11px;color:var(--muted2);font-family:var(--font-m);line-height:1.8;">
      <div>📱 En el celular: abre el menú de compartir con el PDF ya adjunto</div>
      <div>💻 En PC: descarga el PDF para adjuntarlo manualmente</div>
    </div>
    <button id="shareMaintBtn" class="btn-primary" onclick="shareMaintPDF()" style="margin-bottom:8px;">📤 COMPARTIR PDF DE MANTENIMIENTO</button>
    <button class="btn-secondary" onclick="closeModal('maintEmailModal')">CANCELAR</button>
  </div>
</div>

<!-- Stock Email Modal -->
<div class="modal-overlay" id="stockEmailModal">
  <div class="modal">
    <div class="modal-title">📦 Informe de Stock</div>
    <div class="modal-sub" id="stockEmailSub"></div>
    <div class="modal-table-wrap">
      <table class="modal-table">
        <thead><tr><th>Quemador</th><th>Nº Pieza</th><th>Descripción</th><th>Cant</th><th>Marca</th><th>Proveedor</th></tr></thead>
        <tbody id="stockEmailBody"></tbody>
      </table>
    </div>
    <div class="modal-field"><label>DESTINATARIO</label><input id="stockEmailTo" type="email" placeholder="supervisor@empresa.com" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;"></div>
    <button class="btn-primary" onclick="sendStockEmail()" style="margin-bottom:8px;">ABRIR CORREO</button>
    <button class="btn-secondary" onclick="closeModal('stockEmailModal')">CANCELAR</button>
  </div>
</div>

<!-- Delete Catalog Item Modal -->
<div class="modal-overlay" id="delCatModal">
  <div class="modal">
    <div class="modal-title" style="color:var(--danger);">🗑 Eliminar del Catálogo</div>
    <div class="modal-sub">Esta acción oculta el artículo de la lista. Podés restaurarlo después.</div>
    <div style="background:var(--card);border-radius:12px;padding:14px;margin:14px 0;border:1px solid var(--border2);">
      <div style="font-size:11px;color:var(--muted);font-family:var(--font-m);margin-bottom:4px;">ARTÍCULO</div>
      <div style="font-size:13px;font-weight:700;color:var(--ok);font-family:var(--font-m);" id="delCatPart">—</div>
      <div style="font-size:13px;color:var(--text);margin-top:3px;" id="delCatDesc">—</div>
    </div>
    <div style="font-size:12px;color:var(--muted);font-family:var(--font-m);margin-bottom:16px;text-align:center;">
      ¿Confirmás que querés ocultar este artículo?
    </div>
    <button class="btn-primary" onclick="confirmDeleteCatalog()"
      style="background:linear-gradient(135deg,var(--danger),#a00);box-shadow:0 6px 20px rgba(210,40,40,0.3);margin-bottom:8px;">
      🗑 SÍ, OCULTAR ARTÍCULO
    </button>
    <button class="btn-secondary" onclick="closeModal('delCatModal')">CANCELAR</button>
  </div>
</div>

<!-- QR Modal -->
<div class="modal-overlay" id="qrModal">
  <div class="modal">
    <div class="modal-title">🏷️ Etiquetas QR para imprimir</div>
    <div class="modal-sub">Formato 60×50mm · ID visible abajo</div>
    <div class="modal-field">
      <label>QUEMADOR</label>
      <select id="qrBurnerSelect" onchange="renderQR()" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;appearance:none;"></select>
    </div>
    <!-- Preview -->
    <div style="text-align:center;padding:16px 0 8px;">
      <div id="qrPreviewWrap" style="display:inline-block;background:#fff;border:2px solid #ddd;border-radius:8px;padding:10px 14px;min-width:160px;">
        <canvas id="qrCanvas" style="display:block;margin:0 auto;"></canvas>
        <div id="qrIdLabel" style="font-family:monospace;font-weight:900;font-size:15px;color:#111;margin-top:6px;letter-spacing:1px;text-align:center;"></div>
        <div id="qrMetaLabel" style="font-family:monospace;font-size:9px;color:#555;margin-top:2px;text-align:center;"></div>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:8px;font-family:var(--font-m);">Vista previa · 60×50mm al imprimir</div>
    </div>
    <button class="btn-primary" onclick="downloadQR()" style="margin-bottom:8px;">⬇ DESCARGAR ESTE QR</button>
    <button class="btn-secondary" onclick="printAllQR()" style="margin-bottom:8px;border-color:var(--blue);color:var(--blue);">🖨️ IMPRIMIR TODOS LOS QR</button>
    <button class="btn-secondary" onclick="closeModal('qrModal')">CERRAR</button>
  </div>
</div>
<div class="modal-overlay" id="stockModal">
  <div class="modal">
    <div class="modal-title">📦 Agregar Repuesto</div>
    <div class="modal-sub" id="stockModalSub"></div>
    <div class="modal-field"><label>Nº DE PIEZA</label><input type="text" id="stockPart" placeholder="Ej: EC-1234" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;"></div>
    <div class="modal-field"><label>DESCRIPCIÓN</label><input type="text" id="stockDesc" placeholder="Ej: Boquilla TJ 040" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;"></div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <div style="flex:1"><label style="font-size:11px;color:var(--muted2);display:block;margin-bottom:5px;">CANTIDAD</label><input type="number" id="stockQty" placeholder="1" min="1" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;-moz-appearance:textfield;appearance:textfield;"></div>
      <div style="flex:1"><label style="font-size:11px;color:var(--muted2);display:block;margin-bottom:5px;">MARCA</label><input type="text" id="stockBrand" placeholder="ECLIPSE" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;"></div>
    </div>
    <div class="modal-field"><label>PROVEEDOR</label><input type="text" id="stockSupplier" placeholder="Nombre del proveedor" style="width:100%;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:11px 14px;font-size:14px;color:var(--text);font-family:var(--font-m);outline:none;"></div>
    <button class="btn-primary" onclick="addStockItem()" style="margin-bottom:8px;">AGREGAR</button>
    <button class="btn-secondary" onclick="closeModal('stockModal')">CANCELAR</button>
  </div>
</div>

<script>
// ══════════════════════════════════
// DATA
// ══════════════════════════════════
const COEF = {
  'TJ 015': { aire:10.85, gas:1.06, maxBTU:150000, maxAire:16.0, maxGas:14.5, poGas: 7.0  },
  'TJ 025': { aire:17.80, gas:1.78, maxBTU:250000, maxAire:15.8, maxGas:14.2, poGas: 9.1  },
  'TJ 040': { aire:24.23, gas:2.51, maxBTU:400000, maxAire:20.2, maxGas:18.2, poGas:10.8  },
  'TJ 075': { aire:43.85, gas:3.92, maxBTU:750000, maxAire:20.5, maxGas:20.5, poGas:13.5  },
};

const MAINT_ITEMS = [
  { id:'desarme',   title:'Desarme y Limpieza',          hasStock:true },
  { id:'boquilla',  title:'Boquilla',                    hasStock:true },
  { id:'cono',      title:'Cono de Retención',           hasStock:true },
  { id:'bujia',     title:'Bujía de Encendido',          hasStock:true },
  { id:'deteccion', title:'Detección de Llama',          hasStock:true },
  { id:'valvAuto',  title:'Válvulas Automáticas Cierre', hasStock:true },
  { id:'valvProp',  title:'Válvula Proporcionante',      hasStock:true },
  { id:'actuador',  title:'Actuador / Servo Motor',      hasStock:true },
  { id:'flexAire',  title:'Flexibles de Aire',           hasStock:true },
  { id:'flexGas',   title:'Flexibles de Gas',            hasStock:true },
  { id:'trafo',     title:'Transformador de Encendido',  hasStock:true },
  { id:'cables',    title:'Cables y Conectores',         hasStock:true },
];

const DEFAULT_BURNERS = [
  {id:'Q-DES-01',zone:'Desengrase',model:'TJ 040'},
  {id:'Q-DES-02',zone:'Desengrase',model:'TJ 040'},
  {id:'Q-DES-03',zone:'Desengrase',model:'TJ 040'},
  {id:'Q-SEC-01',zone:'Secado',    model:'TJ 075'},
  {id:'Q-SEC-02',zone:'Secado',    model:'TJ 040'},
  {id:'Q-SEC-03',zone:'Secado',    model:'TJ 040'},
  {id:'Q-PRE-01',zone:'Pre-Horno', model:'TJ 025'},
  {id:'Q-PRE-02',zone:'Pre-Horno', model:'TJ 025'},
  {id:'Q-PRE-03',zone:'Pre-Horno', model:'TJ 025'},
  {id:'Q-PRE-04',zone:'Pre-Horno', model:'TJ 025'},
  {id:'Q-PRE-05',zone:'Pre-Horno', model:'TJ 025'},
  {id:'Q-PRE-06',zone:'Pre-Horno', model:'TJ 025'},
  {id:'Q-PRE-07',zone:'Pre-Horno', model:'TJ 025'},
  {id:'Q-PRE-08',zone:'Pre-Horno', model:'TJ 025'},
  {id:'Q-SOL-01',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-02',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-03',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-04',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-05',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-06',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-07',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-08',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-09',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-10',zone:'Soldador',  model:'TJ 015'},
  {id:'Q-SOL-11',zone:'Soldador',  model:'TJ 015'},
];

let burners   = JSON.parse(localStorage.getItem('cb_burners')  || 'null') || DEFAULT_BURNERS;
let readings  = JSON.parse(localStorage.getItem('cb_readings') || '{}');
let history   = JSON.parse(localStorage.getItem('cb_history')  || '[]');
let maintData = JSON.parse(localStorage.getItem('cb_maint')    || '{}');
let appConfig = JSON.parse(localStorage.getItem('cb_config')   || '{}');

// Cargar datos desde Firebase al iniciar
window.addEventListener('load', async () => {
  if (!window._fbReady) return;
  try {
    const docRef = window._fbDoc(window._fbDb, 'ignis', 'datos');
    const snap = await window._fbGetDoc(docRef);
    if (snap.exists()) {
      const data = snap.data();
      if (data.burners)     burners     = data.burners;
      if (data.readings)    readings    = data.readings;
      if (data.history)     history     = data.history;
      if (data.maintData)   maintData   = data.maintData;
      if (data.appConfig)   appConfig   = data.appConfig;
      if (data.inventory)   inventory   = data.inventory;
      if (data.maintPhotos) maintPhotos = data.maintPhotos;
      // Guardar en local también
      localStorage.setItem('cb_burners',  JSON.stringify(burners));
      localStorage.setItem('cb_readings', JSON.stringify(readings));
      localStorage.setItem('cb_history',  JSON.stringify(history));
      localStorage.setItem('cb_maint',    JSON.stringify(maintData));
      localStorage.setItem('cb_config',   JSON.stringify(appConfig));
      localStorage.setItem('cb_inventory',JSON.stringify(inventory));
      console.log('☁️ Datos cargados desde Firebase');
    }
  } catch(e) { console.warn('Firebase load error:', e); }
});

// Cargar usuario registrado
window._currentUser = JSON.parse(localStorage.getItem('ignis_user') || 'null');

let activeBurnerId = null;
let activeMaintId  = null;
let lastCalc = null;
let stockTargetBurnerId = null;
let stockTargetItemId   = null;
let pendingMaint = {};
let maintPhotos  = JSON.parse(localStorage.getItem('cb_photos') || '{}');

function persist() {
  // Guardar local (respaldo)
  localStorage.setItem('cb_burners',  JSON.stringify(burners));
  localStorage.setItem('cb_readings', JSON.stringify(readings));
  localStorage.setItem('cb_history',  JSON.stringify(history));
  localStorage.setItem('cb_maint',    JSON.stringify(maintData));
  localStorage.setItem('cb_config',   JSON.stringify(appConfig));
  // Guardar en Firebase (nube)
  if (window._fbReady) {
    const ts = Date.now();
    window._lastSaveTs = ts;
    const docRef = window._fbDoc(window._fbDb, 'ignis', 'datos');
    window._fbSetDoc(docRef, {
      burners, readings, history, maintData, appConfig, inventory, maintPhotos,
      _ts: ts, _updated: new Date().toISOString()
    }).catch(e => console.warn('Firebase sync error:', e));
  }
}

// ══════════════════════════════════
// PASSWORD / LOCK
// ══════════════════════════════════
const DEFAULT_PASS = '1729';
const DEFAULT_ADMIN_PASS = 'ramos2042';


function saveRegister() {
  const nombre   = document.getElementById('regNombre').value.trim();
  const apellido = document.getElementById('regApellido').value.trim();
  const empresa  = document.getElementById('regEmpresa').value.trim();
  if (!nombre || !apellido) {
    document.getElementById('regError').textContent = '⚠ Nombre y apellido son obligatorios.';
    return;
  }
  const user = { nombre, apellido, empresa, fecha: new Date().toISOString() };
  localStorage.setItem('ignis_user', JSON.stringify(user));
  window._currentUser = user;
  // Registrar en Firebase
  if (window._fbReady) {
    const ts = Date.now();
    const docRef = window._fbDoc(window._fbDb, 'ignis', 'usuarios');
    window._fbSetDoc(docRef, {
      [nombre + '_' + apellido]: { nombre, apellido, empresa, primerAcceso: new Date().toISOString() }
    }, { merge: true }).catch(e => console.warn('Firebase user reg error:', e));
  }
  document.getElementById('registerScreen').classList.remove('active');
  document.getElementById('homeScreen').classList.add('active');
}

function checkPassword() {
  const input = document.getElementById('lockInput').value;
  const stored = appConfig.password || DEFAULT_PASS;
  if (input === stored) {
    document.getElementById('lockInput').value = '';
    document.getElementById('lockError').textContent = '';
    // Ver si ya está registrado en este dispositivo
    const userReg = JSON.parse(localStorage.getItem('ignis_user') || 'null');
    if (userReg && userReg.nombre) {
      // Ya registrado — ir al home directamente
      document.getElementById('lockScreen').classList.remove('active');
      document.getElementById('homeScreen').classList.add('active');
    } else {
      // Mostrar pantalla de registro
      document.getElementById('lockScreen').classList.remove('active');
      document.getElementById('registerScreen').classList.add('active');
    }
  } else {
    const inp = document.getElementById('lockInput');
    inp.classList.add('shake');
    document.getElementById('lockError').textContent = '⚠ Contraseña incorrecta';
    inp.value = '';
    setTimeout(() => inp.classList.remove('shake'), 400);
  }
}


function goTo(screenId) {
  // Detener scanner si salimos de scanScreen
  const fromScan = document.getElementById('scanScreen').classList.contains('active');
  if (fromScan && screenId !== 'scanScreen' && screenId !== 'burnerInfoScreen') {
    stopScanner();
  }
  
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  
  // Iniciar scanner si entramos a scanScreen
  if (screenId === 'scanScreen') {
    setTimeout(startScanner, 300);
  }
  if (screenId === 'calibScreen') renderCalibList();
  if (screenId === 'maintScreen') renderMaintList();
  if (screenId === 'stockScreen') { showStockLock(); }
}

// ══════════════════════════════════
// SETTINGS / BRANDING
// ══════════════════════════════════
function applyConfig() {
  const name    = appConfig.name    || 'IGNIS';
  const tagline = appConfig.tagline || 'ECLIPSE TJ · Sistema de Gestión';
  const logo    = appConfig.logo;

  // split last 4 chars as colored
  const split = Math.max(name.length - 4, 1);
  document.getElementById('homeAppName').innerHTML =
    name.slice(0, split) + '<span>' + name.slice(split) + '</span>';
  document.getElementById('homeTagline').textContent = tagline;

  const logoEl = document.getElementById('homeLogo');
  if (logo) {
    logoEl.innerHTML = `<img src="${logo}" alt="logo">`;
  } else {
    logoEl.innerHTML = '🔥';
  }
}

function openSettings() {
  // Pedir clave de administrador
  const adminPass = prompt('🔐 Clave de administrador:');
  if (adminPass === null) return; // canceló
  const stored = appConfig.adminPassword || DEFAULT_ADMIN_PASS;
  if (adminPass !== stored) {
    alert('❌ Clave de administrador incorrecta.');
    return;
  }
  document.getElementById('settAppName').value  = appConfig.name    || '';
  document.getElementById('settTagline').value  = appConfig.tagline || '';
  const lp = document.getElementById('logoPreview');
  if (appConfig.logo) {
    lp.innerHTML = `<img src="${appConfig.logo}" style="width:100%;height:100%;object-fit:cover;border-radius:14px;">`;
  } else {
    lp.innerHTML = '<span id="logoEmoji">🔥</span>';
  }
  openModal('settingsModal');
}

function handleLogoUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const lp = document.getElementById('logoPreview');
    lp.innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:14px;">`;
    appConfig.logoTemp = ev.target.result;
  };
  reader.readAsDataURL(file);
}

function saveSettings() {
  const name    = document.getElementById('settAppName').value.trim()    || 'IGNIS';
  const tagline = document.getElementById('settTagline').value.trim()    || 'ECLIPSE TJ · Sistema de Gestión';
  const passNew  = document.getElementById('settPassNew').value.trim();
  const passConf = document.getElementById('settPassConfirm').value.trim();

  if (passNew) {
    if (passNew !== passConf) {
      alert('Las contraseñas no coinciden. Volvé a intentarlo.');
      return;
    }
    if (passNew.length < 4) {
      alert('La contraseña debe tener al menos 4 caracteres.');
      return;
    }
    appConfig.password = passNew;
    alert('✅ Contraseña actualizada correctamente.');
  }

  appConfig.name    = name;
  appConfig.tagline = tagline;
  if (appConfig.logoTemp) { appConfig.logo = appConfig.logoTemp; delete appConfig.logoTemp; }

  // Clear password fields
  document.getElementById('settPassNew').value    = '';
  document.getElementById('settPassConfirm').value = '';

  // Stock password
  const stockPassNew = document.getElementById('settStockPass')?.value.trim();
  if (stockPassNew) {
    if (stockPassNew.length < 4) { alert('La clave de stock debe tener al menos 4 caracteres.'); return; }
    appConfig.stockPassword = stockPassNew;
    alert('Clave de stock actualizada.');
  }
  document.getElementById('settStockPass').value = '';

  // Clave de administrador
  const adminPassNew = document.getElementById('settAdminPass')?.value.trim();
  if (adminPassNew) {
    if (adminPassNew.length < 4) { alert('La clave de administrador debe tener al menos 4 caracteres.'); return; }
    appConfig.adminPassword = adminPassNew;
    alert('✅ Clave de administrador actualizada.');
  }
  document.getElementById('settAdminPass').value = '';

  persist();
  
// ══════════════════════════════════
// QR SCANNER
// ══════════════════════════════════
function showBurnerInfo(burnerId) {
  const b = burners.find(x => x.id === burnerId);
  if (!b) {
    alert('Quemador no encontrado: ' + burnerId);
    goTo('scanScreen');
    return;
  }
  
  document.getElementById('biTitle').textContent = b.id;
  document.getElementById('biSub').textContent = `${b.model} · ${b.zone}`;
  
  // Última calibración
  const lastCalib = history.filter(h => h.burnerId === b.id).sort((a,c) => new Date(c.date) - new Date(a.date))[0];
  const calibStatus = lastCalib ? (lastCalib.diag?.estado || 'CALIBRADO') : 'Sin calibrar';
  const calibDate = lastCalib ? lastCalib.date : '—';
  const calibUser = lastCalib?.user || window._currentUser?.nombre || '—';
  
  // Último mantenimiento
  const maintInfo = maintData[b.id];
  const maintDate = maintInfo?.fecha || '—';
  const maintItems = maintInfo ? Object.values(maintInfo.items || {}).filter(x=>x!=='ok').length : 0;
  const maintTotal = maintInfo ? Object.keys(maintInfo.items || {}).length : 0;
  const maintPct = maintTotal > 0 ? Math.round((maintTotal - maintItems) / maintTotal * 100) : 0;
  const maintPhoto = maintPhotos[b.id];
  
  // Stock de repuestos del modelo
  const stockItems = inventory.filter(s => s.models === b.model || s.models === 'TODOS');
  const stockCount = stockItems.reduce((sum, s) => sum + (s.qty || 0), 0);
  
  const body = document.getElementById('biBody');
  body.innerHTML = `
    <div class="burner-card" style="--bc:var(--ok);gap:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="font-size:16px;font-weight:700;color:var(--text);">${b.id}</div>
        <div style="font-size:13px;color:var(--muted);font-family:var(--font-m);">${b.model} · ${b.zone}</div>
      </div>
    </div>
    
    <div class="burner-card" style="--bc:var(--ok);gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="font-size:20px;">🔥</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;color:var(--text);">Última Calibración</div>
          <div style="font-size:12px;color:var(--muted);font-family:var(--font-m);margin-top:2px;">${calibDate}</div>
        </div>
        <div style="padding:6px 12px;background:rgba(0,230,118,0.12);color:var(--ok);border-radius:8px;font-size:12px;font-weight:700;font-family:var(--font-m);">
          ${calibStatus}
        </div>
      </div>
      ${lastCalib ? '<div style="font-size:11px;color:var(--muted);font-family:var(--font-m);">Técnico: ' + calibUser + '</div>' : ''}
    </div>
    
    <div class="burner-card" style="--bc:var(--blue);gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="font-size:20px;">🔧</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;color:var(--text);">Último Mantenimiento</div>
          <div style="font-size:12px;color:var(--muted);font-family:var(--font-m);margin-top:2px;">${maintDate}</div>
        </div>
        <div style="padding:6px 12px;background:rgba(68,138,255,0.12);color:var(--blue);border-radius:8px;font-size:12px;font-weight:700;font-family:var(--font-m);">
          ${maintPct}%
        </div>
      </div>
      ${maintPhoto ? '<img src="' + maintPhoto.data + '" style="width:100%;height:120px;object-fit:cover;border-radius:10px;margin-top:4px;">' : ''}
      ${maintInfo ? '<div style="font-size:11px;color:var(--muted);font-family:var(--font-m);">Items afectados: ' + maintItems + ' de ' + maintTotal + '</div>' : ''}
    </div>
    
    <div class="burner-card" style="--bc:var(--warn);gap:8px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="font-size:20px;">📦</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;color:var(--text);">Stock de Repuestos</div>
          <div style="font-size:12px;color:var(--muted);font-family:var(--font-m);margin-top:2px;">${b.model}</div>
        </div>
        <div style="padding:6px 12px;background:rgba(255,171,0,0.12);color:var(--warn);border-radius:8px;font-size:12px;font-weight:700;font-family:var(--font-m);">
          ${stockCount} pzs
        </div>
      </div>
      <div style="font-size:11px;color:var(--muted);font-family:var(--font-m);">${stockItems.length} tipos de repuestos disponibles</div>
    </div>
    
    <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);text-align:center;margin-top:8px;">
      Escaneado por ${window._currentUser?.nombre || 'Usuario'} · ${new Date().toLocaleString('es', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}
    </div>
  `;
  
  goTo('burnerInfoScreen');
}

applyConfig();
  closeModal('settingsModal');
}

// ══════════════════════════════════
// CALIBRATION
// ══════════════════════════════════
function calcBurner(model, dpAire, dpGas) {
  const c = COEF[model];
  if (!c || dpAire <= 0 || dpGas <= 0) return null;
  const flujoAire = c.aire * Math.sqrt(dpAire);
  const flujoGas  = c.gas  * Math.sqrt(dpGas);
  const potencia  = c.maxBTU * Math.sqrt(dpGas / c.poGas);  // fórmula correcta: maxBTU × √(ΔPgas / POgas)
  const exceso    = (flujoAire / flujoGas) / 9.5 - 1;
  const carga     = potencia / c.maxBTU;
  let diag, diagClass;
  if      (exceso > 0.25)                    { diag='💨 MUCHO AIRE';        diagClass='diag-warn';   }
  else if (exceso >= 0.03)                   { diag='✅ ÓPTIMO';            diagClass='diag-ok';     }
  else if (exceso >= -0.02 && exceso < 0.03) { diag='⚖️ ESTEQUIOMÉTRICO';  diagClass='diag-stoic';  }
  else if (exceso >= -0.10 && exceso < -0.02){ diag='🔥 EXCESO GAS';       diagClass='diag-excess'; }
  else                                        { diag='⚠️ MUCHO GAS';        diagClass='diag-danger'; }
  return { flujoAire, flujoGas, potencia, exceso, carga, diag, diagClass };
}

function renderCalibList() {
  const zones = [...new Set(burners.map(b => b.zone))];
  const done   = Object.keys(readings).length;
  const issues = Object.values(readings).filter(r => r.diagClass !== 'diag-ok').length;

  document.getElementById('summaryBar').innerHTML = `
    <div class="sum-box"><div class="sum-val" style="color:var(--ok)">${done}</div><div class="sum-lbl">CALIBRADOS</div></div>
    <div class="sum-box"><div class="sum-val" style="color:var(--muted)">${burners.length-done}</div><div class="sum-lbl">PENDIENTES</div></div>
    <div class="sum-box"><div class="sum-val" style="color:${issues>0?'var(--warn)':'var(--muted)'}">${issues}</div><div class="sum-lbl">CON ALERTA</div></div>`;

  let html = '';
  zones.forEach(zone => {
    html += `<div class="zone-label">${zone}</div>`;
    burners.filter(b => b.zone === zone).forEach(b => {
      const r = readings[b.id];
      let sc='s-pending', st='PENDIENTE', bc='var(--border)', vals='';
      if (r) {
        if      (r.diagClass==='diag-ok')     { sc='s-ok';     st='ÓPTIMO';          bc='var(--ok)'; }
        else if (r.diagClass==='diag-stoic')   { sc='s-ok';     st='ESTEQUIOMÉTRICO'; bc='var(--blue)'; }
        else if (r.diagClass==='diag-excess')  { sc='s-warn';   st='EXCESO GAS';      bc='#ff6400'; }
        else if (r.diagClass==='diag-warn')    { sc='s-warn';   st='MUCHO AIRE';      bc='var(--warn)'; }
        else                                   { sc='s-danger'; st='MUCHO GAS';       bc='var(--danger)'; }
        vals = `<div class="burner-values">ΔPa:${r.dpAire} · ΔPg:${r.dpGas} · ${(r.exceso*100).toFixed(1)}% exc · ${Math.round(r.potencia).toLocaleString('es-AR')} BTU/h · ${r.ts}</div>`;
      }
      // Diagnóstico mantenimiento
      const m = maintData[b.id] || {};
      const boquilla = m['boquilla']?.status || null;
      const cono     = m['cono']?.status || null;
      const hasMaint = boquilla || cono;
      const hasAlert = boquilla === 'afectado' || boquilla === 'cambio' || cono === 'afectado' || cono === 'cambio';
      const maintIcon = !hasMaint ? '' : hasAlert
        ? `<span style="font-size:10px;color:var(--warn);font-family:var(--font-m);margin-left:6px;" title="Ver diagnóstico">⚠ MANT</span>`
        : `<span style="font-size:10px;color:var(--ok);font-family:var(--font-m);margin-left:6px;">✓ MANT</span>`;

      html += `<div class="burner-card" style="--bc:${bc}" onclick="openCalibForm('${b.id}')">
        <div style="flex:1">
          <div class="burner-id" style="display:flex;align-items:center;">${b.id}${maintIcon}</div>
          <div class="burner-meta">${b.model} · ${b.zone}</div>${vals}
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          <div class="burner-status ${sc}">${st}</div>
          ${hasMaint ? `<button onclick="event.stopPropagation();toggleDiag('${b.id}',this)" style="font-size:9px;background:none;border:1px solid var(--border2);color:var(--muted);border-radius:6px;padding:2px 7px;cursor:pointer;font-family:var(--font-m);">DIAG ▾</button>` : ''}
        </div>
      </div>
      <div id="diag-${b.id}" style="display:none;background:var(--card);border-radius:0 0 12px 12px;padding:10px 14px;margin-top:-8px;border:1px solid var(--border2);border-top:none;font-size:11px;font-family:var(--font-m);">
        <div style="margin-bottom:4px;color:var(--muted);font-size:10px;">DIAGNÓSTICO MANTENIMIENTO</div>
        <div style="display:flex;gap:12px;">
          <div>Boquilla: <span style="color:${boquilla==='ok'?'var(--ok)':boquilla==='afectado'?'var(--warn)':boquilla==='cambio'?'var(--danger)':'var(--muted)'};">${boquilla ? boquilla.toUpperCase() : '—'}</span></div>
          <div>Cono Ret.: <span style="color:${cono==='ok'?'var(--ok)':cono==='afectado'?'var(--warn)':cono==='cambio'?'var(--danger)':'var(--muted)'};">${cono ? cono.toUpperCase() : '—'}</span></div>
        </div>
      </div>`;
    });
  });
  document.getElementById('burnerList').innerHTML = html;

  const fab = document.getElementById('fabSend');
  document.getElementById('fabCount').textContent = done;
  done > 0 ? fab.classList.remove('hidden') : fab.classList.add('hidden');
}

function openCalibForm(id) {
  activeBurnerId = id;
  const b = burners.find(x => x.id === id);
  document.getElementById('formTitle').textContent = id;
  document.getElementById('formSub').textContent   = `${b.model} · ${b.zone}`;
  const r = readings[id];
  document.getElementById('inp-aire').value = r ? r.dpAire : '';
  document.getElementById('inp-gas').value  = r ? r.dpGas  : '';

  // Poblar diagnóstico de mantenimiento
  const m = maintData[id] || {};
  const statusColor = s => s==='ok' ? 'var(--ok)' : s==='afectado' ? 'var(--warn)' : s==='cambio' ? 'var(--danger)' : 'var(--muted)';
  const statusText  = s => s==='ok' ? '✓ OK' : s==='afectado' ? '⚠ AFECTADO' : s==='cambio' ? '🔄 CAMBIO' : 'Sin datos';
  const bq = m['boquilla']?.status || null;
  const cn = m['cono']?.status || null;
  document.getElementById('diag-boquilla').textContent  = statusText(bq);
  document.getElementById('diag-boquilla').style.color  = statusColor(bq);
  document.getElementById('diag-cono').textContent      = statusText(cn);
  document.getElementById('diag-cono').style.color      = statusColor(cn);

  hideView('cv-list'); hideView('cv-history'); showView('cv-form');
  document.getElementById('calibScroll').scrollTop = 0;
  document.getElementById('valToast').classList.remove('show');
  document.getElementById('inp-aire').classList.remove('error-field');
  document.getElementById('inp-gas').classList.remove('error-field');
  if (r) calculate(); else { document.getElementById('resultPanel').classList.remove('visible'); document.getElementById('btnSave').disabled = true; }
}

function backToCalibList() {
  hideView('cv-form'); showView('cv-list'); activeBurnerId = null; renderCalibList();
}

function calculate() {
  const b = burners.find(x => x.id === activeBurnerId);
  const c = COEF[b.model];
  const dpAire = parseFloat(document.getElementById('inp-aire').value);
  const dpGas  = parseFloat(document.getElementById('inp-gas').value);
  const toast  = document.getElementById('valToast');
  const inA    = document.getElementById('inp-aire');
  const inG    = document.getElementById('inp-gas');

  inA.classList.remove('error-field');
  inG.classList.remove('error-field');
  toast.classList.remove('show');

  // Validation
  let errors = [];
  if (dpAire > 0 && dpAire > c.maxAire) {
    errors.push(`⚠ ΔP Aire (${dpAire} mbar) supera el máximo para ${b.model} (${c.maxAire} mbar). Verificá el ingreso o bajá la presión.`);
    inA.classList.add('error-field');
  }
  if (dpGas > 0 && dpGas > c.maxGas) {
    errors.push(`⚠ ΔP Gas (${dpGas} mbar) supera el máximo para ${b.model} (${c.maxGas} mbar). Verificá el ingreso o bajá la presión.`);
    inG.classList.add('error-field');
  }
  if (dpAire < 0 || dpGas < 0) {
    errors.push('⚠ Los valores no pueden ser negativos.');
  }

  if (errors.length) {
    toast.innerHTML = errors.join('<br>');
    toast.classList.add('show');
    document.getElementById('resultPanel').classList.remove('visible');
    document.getElementById('btnSave').disabled = true;
    lastCalc = null; return;
  }

  if (!dpAire || !dpGas || dpAire <= 0 || dpGas <= 0) {
    document.getElementById('resultPanel').classList.remove('visible');
    document.getElementById('btnSave').disabled = true;
    lastCalc = null; return;
  }

  const r = calcBurner(b.model, dpAire, dpGas);
  if (!r) return;
  lastCalc = {...r, dpAire, dpGas};

  document.getElementById('resultDiag').textContent = r.diag;
  document.getElementById('resultDiag').className   = 'result-diag ' + r.diagClass;
  document.getElementById('res-pot').textContent     = Math.round(r.potencia).toLocaleString('es-AR');
  document.getElementById('res-carga').textContent   = (r.carga*100).toFixed(1)+'%';
  document.getElementById('res-aire').textContent    = r.flujoAire.toFixed(2);
  document.getElementById('res-gas').textContent     = r.flujoGas.toFixed(2);
  document.getElementById('res-exceso').textContent  = (r.exceso*100).toFixed(1)+'%';
  document.getElementById('res-consumo').textContent = r.flujoGas.toFixed(2);

  const pct = Math.min(r.exceso * 100, 50);
  const gc  = r.diagClass==='diag-ok'?'var(--ok)':r.diagClass==='diag-stoic'?'var(--blue)':r.diagClass==='diag-excess'?'#ff6400':r.diagClass==='diag-warn'?'var(--warn)':'var(--danger)';
  const gf  = document.getElementById('gaugeFill');
  gf.style.width      = (pct/50*100)+'%';
  gf.style.background = gc;

  document.getElementById('resultPanel').classList.add('visible');
  document.getElementById('btnSave').disabled = false;
}

function saveReading() {
  if (!lastCalc || !activeBurnerId) return;
  // Fecha y hora automática al guardar
  const now  = new Date();
  const ts   = now.toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  const date = now.toLocaleDateString('es');
  readings[activeBurnerId] = {...lastCalc, ts, date};
  history.unshift({...lastCalc, id:activeBurnerId, ts, date});
  if (history.length > 200) history.length = 200;
  persist();
  backToCalibList();
}

function switchCalibTab(tab) {
  document.querySelectorAll('#calibScreen .tab-btn').forEach((b,i)=>b.classList.toggle('active',(i===0&&tab==='list')||(i===1&&tab==='history')));
  hideView('cv-form');
  if (tab==='list')    { showView('cv-list'); hideView('cv-history'); renderCalibList(); }
  else                 { hideView('cv-list'); showView('cv-history'); renderHistory(); }
}

function renderHistory() {
  const el = document.getElementById('historyList');
  if (!history.length) { el.innerHTML=`<div class="empty"><div class="empty-icon">📋</div><div class="empty-text">Sin registros aún</div></div>`; return; }
  el.innerHTML = history.map(h=>{
    const color = h.diagClass==='diag-ok'?'var(--ok)':h.diagClass==='diag-warn'?'var(--warn)':'var(--danger)';
    return `<div class="hist-card anim">
      <div class="hist-top"><span class="hist-id">${h.id}</span><span class="hist-time">${h.date} ${h.ts}</span></div>
      <div style="color:${color};font-size:13px;font-weight:700;margin-bottom:4px;">${h.diag}</div>
      <div class="hist-vals"><span>ΔPa:${h.dpAire}</span><span>ΔPg:${h.dpGas}</span><span>${Math.round(h.potencia).toLocaleString('es-AR')} BTU/h</span><span>Exc:${(h.exceso*100).toFixed(1)}%</span></div>
    </div>`;
  }).join('');
}

function showAddBurner() {
  const id    = prompt('ID del quemador (ej: Q-HON-01):'); if (!id) return;
  const zone  = prompt('Zona:'); if (!zone) return;
  const model = prompt('Modelo (TJ 015 / TJ 025 / TJ 040 / TJ 075):');
  if (!COEF[model]) { alert('Modelo no válido'); return; }
  if (burners.find(b=>b.id===id)) { alert('Ya existe ese ID'); return; }
  burners.push({id,zone,model}); persist(); renderCalibList();
}


function showAddBurnerSecure() {
  const stored = appConfig.stockPassword || DEFAULT_STOCK_PASS;
  const input = prompt('Clave para agregar quemador:');
  if (input === null) return;
  if (input.trim() === stored) {
    showAddBurner();
  } else {
    alert('Clave incorrecta.');
  }
}

function clearCalibSecure() {
  const stored = appConfig.stockPassword || DEFAULT_STOCK_PASS;
  const input = prompt('⚠️ Esto reiniciará TODAS las mediciones.\nIngresá la clave para continuar:');
  if (input === null) return;
  if (input.trim() === stored) {
    clearCalib();
  } else {
    alert('Clave incorrecta.');
  }
}

function toggleDiag(id, btn) {
  const el = document.getElementById('diag-' + id);
  if (!el) return;
  const visible = el.style.display !== 'none';
  el.style.display = visible ? 'none' : 'block';
  btn.textContent = visible ? 'DIAG ▾' : 'DIAG ▴';
}

function clearCalib() {
  if (!confirm('¿Resetear todas las mediciones del turno?')) return;
  readings = {}; persist(); renderCalibList();
  document.getElementById('fabSend').classList.add('hidden');
}

// ══════════════════════════════════
// MAINTENANCE
// ══════════════════════════════════
function renderMaintList() {
  const zones = [...new Set(burners.map(b=>b.zone))];
  let html = '';
  zones.forEach(zone=>{
    html += `<div class="zone-label">${zone}</div>`;
    burners.filter(b=>b.zone===zone).forEach(b=>{
      const m   = maintData[b.id] || {};
      const done = MAINT_ITEMS.filter(i=>m[i.id]?.status).length;
      const pct  = Math.round(done/MAINT_ITEMS.length*100);
      let bc = 'var(--border)';
      if (pct===100) bc='var(--ok)';
      else if (pct>0) bc='var(--blue)';
      html+=`<div class="maint-burner-card" style="--bc:${bc}" onclick="openMaintForm('${b.id}')">
        <div style="flex:1">
          <div class="burner-id">${b.id}</div>
          <div class="burner-meta">${b.model} · ${b.zone}</div>
          <div class="maint-progress"><div class="maint-progress-fill" style="width:${pct}%"></div></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          <div class="burner-status" style="background:${pct===100?'rgba(0,230,118,0.12)':'rgba(68,138,255,0.1)'};color:${pct===100?'var(--ok)':'var(--blue)'}">${pct}%</div>
          ${maintPhotos[b.id] ? '<div style="font-size:11px;color:var(--muted);font-family:var(--font-m);">📷</div>' : ''}
        </div>
      </div>`;
    });
  });
  document.getElementById('maintBurnerList').innerHTML = html;
  // Show send FAB on list, hide save FAB
  document.getElementById('fabMaintSend').classList.remove('hidden');
  document.getElementById('fabMaint').classList.add('hidden');
}

function openMaintForm(id) {
  activeMaintId = id;
  const b = burners.find(x=>x.id===id);
  document.getElementById('maintFormTitle').textContent = id;
  document.getElementById('maintFormSub').textContent   = `${b.model} · ${b.zone}`;
  pendingMaint = JSON.parse(JSON.stringify(maintData[id] || {}));

  // Load existing photo if any
  const savedPhoto = maintPhotos[id];
  if (savedPhoto) {
    document.getElementById('photoPreview').src = savedPhoto.data;
    document.getElementById('photoDate').textContent = '📅 ' + savedPhoto.date;
    document.getElementById('photoPreviewWrap').style.display = 'block';
    document.getElementById('photoEmpty').style.display = 'none';
  } else {
    document.getElementById('photoPreviewWrap').style.display = 'none';
    document.getElementById('photoEmpty').style.display = 'flex';
    document.getElementById('photoPreview').src = '';
    document.getElementById('photoDate').textContent = '';
  }
  document.getElementById('photoInput').value = '';

  let html = '';
  MAINT_ITEMS.forEach((item, idx) => {
    const d      = pendingMaint[item.id] || {};
    const selOk  = d.status==='ok'       ? 'sel-ok'       : '';
    const selAf  = d.status==='afectado' ? 'sel-afectado' : '';
    const selCam = d.status==='cambio'   ? 'sel-cambio'   : '';
    const num    = idx + 1;

    html += `<div class="checklist-item">
      <div class="ci-header">
        <div class="ci-num">${num}</div>
        <div class="ci-title">${item.title}</div>
      </div>
      <div class="ci-options">
        <div class="ci-opt ${selOk}"  onclick="setStatus('${item.id}','ok',this)">✓ OK</div>
        <div class="ci-opt ${selAf}"  onclick="setStatus('${item.id}','afectado',this)">⚡ AFECTADO</div>
        <div class="ci-opt ${selCam}" onclick="setStatus('${item.id}','cambio',this)">🔄 CAMBIO</div>
      </div>
      ${item.hasStock ? `<div class="ci-dates">
        <div>
          <div class="ci-date-label" style="display:flex;align-items:center;gap:4px;">
            FECHA INSTALACIÓN <span style="font-size:9px;color:var(--muted);">🔒</span>
          </div>
          <input type="date" id="dateInst-${item.id}" value="${d.dateInst||''}"
            onfocus="checkInstPass(event,'${item.id}')"
            onchange="setDate('${item.id}','dateInst',this.value)"
            style="cursor:pointer;">
        </div>
        <div id="dates-${item.id}" style="transition:opacity 0.2s;${d.status==='cambio'?'':'opacity:0.35;pointer-events:none;'}">
          <div class="ci-date-label">FECHA CAMBIO</div>
          <input type="date" id="dateCamb-${item.id}" value="${d.dateCamb||''}" onchange="setDate('${item.id}','dateCamb',this.value)">
        </div>
      </div>` : ''}
    </div>`;
  });

  document.getElementById('checklistItems').innerHTML = html;
  document.getElementById('maintView-list').style.display = 'none';
  document.getElementById('maintView-form').style.display = 'block';
  document.getElementById('maintScroll').scrollTop = 0;
  // Forzar visibilidad del botón guardar
  const fabM = document.getElementById('fabMaint');
  const fabS = document.getElementById('fabMaintSend');
  fabM.classList.remove('hidden');
  fabM.style.opacity = '1';
  fabM.style.pointerEvents = 'auto';
  fabS.classList.add('hidden');
  fabS.style.opacity = '0';
  fabS.style.pointerEvents = 'none';
}

function setStatus(itemId, status, el) {
  if (!pendingMaint[itemId]) pendingMaint[itemId] = {};

  // Toggle: if already selected, deselect
  const current = pendingMaint[itemId].status;
  if (current === status) {
    pendingMaint[itemId].status = null;
    el.classList.remove('sel-ok','sel-afectado','sel-cambio');
    // Disable date cambio if deselecting cambio
    if (status === 'cambio') {
      const datesEl = document.getElementById('dates-' + itemId);
      if (datesEl) { datesEl.style.opacity='0.35'; datesEl.style.pointerEvents='none'; }
    }
    return;
  }

  pendingMaint[itemId].status = status;
  const parent = el.closest('.ci-options');
  parent.querySelectorAll('.ci-opt').forEach(o =>
    o.classList.remove('sel-ok','sel-afectado','sel-cambio'));
  const cls = status==='ok'?'sel-ok':status==='afectado'?'sel-afectado':'sel-cambio';
  el.classList.add(cls);

  // FECHA CAMBIO — solo activa con CAMBIO
  const datesEl = document.getElementById('dates-' + itemId);
  if (datesEl) {
    if (status === 'cambio') {
      datesEl.style.opacity = '1';
      datesEl.style.pointerEvents = 'auto';
      // Auto-fill today if empty
      const inp = document.getElementById('dateCamb-' + itemId);
      if (inp && !inp.value) {
        const hoy = new Date().toISOString().split('T')[0];
        inp.value = hoy;
        setDate(itemId, 'dateCamb', hoy);
      }
    } else {
      datesEl.style.opacity = '0.35';
      datesEl.style.pointerEvents = 'none';
    }
  }
}

// Fecha instalación protegida — pide clave solo una vez por sesión
let instPassUnlocked = false;

function checkInstPass(event, itemId) {
  event.preventDefault();
  event.target.blur();

  // Si ya está desbloqueado en esta sesión, abre directo
  if (instPassUnlocked) {
    const el = document.getElementById('dateInst-' + itemId);
    if (el) { el.removeAttribute('onfocus'); el.focus(); }
    return;
  }

  const stored = appConfig.stockPassword || DEFAULT_STOCK_PASS;
  const input  = prompt('Clave para editar fecha de instalación:');
  if (input === null) return;

  if (input.trim() === stored) {
    instPassUnlocked = true;
    setTimeout(() => {
      const el = document.getElementById('dateInst-' + itemId);
      if (el) {
        el.removeAttribute('onfocus');
        el.focus();
      }
    }, 100);
  } else {
    alert('Clave incorrecta.');
  }
}

function setDate(itemId, field, val) {
  if (!pendingMaint[itemId]) pendingMaint[itemId] = {};
  pendingMaint[itemId][field] = val;
}

function openStockModal(burnerId, itemId) {
  stockTargetBurnerId = burnerId;
  stockTargetItemId   = itemId;
  document.getElementById('stockModalSub').textContent = `${burnerId} · Stock de Repuestos`;
  document.getElementById('stockPart').value     = '';
  document.getElementById('stockDesc').value     = '';
  document.getElementById('stockQty').value      = '';
  document.getElementById('stockBrand').value    = '';
  document.getElementById('stockSupplier').value = '';
  openModal('stockModal');
}

function addStockItem() {
  const part     = document.getElementById('stockPart').value.trim();
  const desc     = document.getElementById('stockDesc').value.trim();
  const qty      = parseInt(document.getElementById('stockQty').value)||1;
  const brand    = document.getElementById('stockBrand').value.trim();
  const supplier = document.getElementById('stockSupplier').value.trim();
  if (!part && !desc) { alert('Ingresá al menos Nº de pieza o descripción'); return; }
  if (!pendingMaint[stockTargetItemId]) pendingMaint[stockTargetItemId] = {};
  if (!pendingMaint[stockTargetItemId].stock) pendingMaint[stockTargetItemId].stock = [];
  pendingMaint[stockTargetItemId].stock.push({part,desc,qty,brand,supplier});

  // re-render stock body
  const list  = pendingMaint[stockTargetItemId].stock;
  const tbody = document.getElementById('stockBody-'+stockTargetItemId);
  if (tbody) {
    tbody.innerHTML = list.map((s,i)=>`<tr>
      <td>${s.part||'—'}</td><td>${s.desc||'—'}</td>
      <td>${s.qty||1}</td><td>${s.brand||'—'}</td><td>${s.supplier||'—'}</td>
      <td style="cursor:pointer;color:var(--danger)" onclick="removeStock('${stockTargetItemId}',${i})">✕</td>
    </tr>`).join('');
  }
  closeModal('stockModal');
}

function removeStock(itemId, idx) {
  if (!pendingMaint[itemId]?.stock) return;
  pendingMaint[itemId].stock.splice(idx,1);
  const tbody = document.getElementById('stockBody-'+itemId);
  if (tbody) {
    const list = pendingMaint[itemId].stock;
    tbody.innerHTML = list.map((s,i)=>`<tr>
      <td>${s.part||'—'}</td><td>${s.desc||'—'}</td>
      <td>${s.qty||1}</td><td>${s.brand||'—'}</td><td>${s.supplier||'—'}</td>
      <td style="cursor:pointer;color:var(--danger)" onclick="removeStock('${itemId}',${i})">✕</td>
    </tr>`).join('');
  }
}

// ══════════════════════════════════
// FOTO DE QUEMADOR
// ══════════════════════════════════
function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Resize to max 800px wide to save space in localStorage
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const MAX = 600;
      let w = img.width, h = img.height;
      if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const data = canvas.toDataURL('image/jpeg', 0.70);
      const fecha = new Date().toLocaleDateString('es') + ' ' +
                    new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});

      // Save to memory (persist on saveMaint)
      maintPhotos[activeMaintId] = { data, date: fecha, w, h };

      // Show preview
      document.getElementById('photoPreview').src = data;
      document.getElementById('photoDate').textContent = '📅 ' + fecha;
      document.getElementById('photoPreviewWrap').style.display = 'block';
      document.getElementById('photoEmpty').style.display = 'none';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function removePhoto() {
  if (!confirm('¿Eliminar la foto de este quemador?')) return;
  delete maintPhotos[activeMaintId];
  localStorage.setItem('cb_photos', JSON.stringify(maintPhotos));
  document.getElementById('photoPreviewWrap').style.display = 'none';
  document.getElementById('photoEmpty').style.display = 'flex';
  document.getElementById('photoPreview').src = '';
  document.getElementById('photoInput').value = '';
}

function saveMaint() {
  maintData[activeMaintId] = JSON.parse(JSON.stringify(pendingMaint));
  // Guardar foto en localStorage Y en Firebase (via persist)
  localStorage.setItem('cb_photos', JSON.stringify(maintPhotos));
  persist(); // persist() ahora incluye maintPhotos → sube a Firebase
  backToMaintList();
}

function backToMaintList() {
  document.getElementById('maintView-form').style.display = 'none';
  document.getElementById('maintView-list').style.display = 'block';
  document.getElementById('fabMaint').classList.add('hidden');
  activeMaintId = null;
  renderMaintList();
}

// ══════════════════════════════════
// EMAIL
// ══════════════════════════════════
function openEmailModal() {
  const done = Object.entries(readings);
  document.getElementById('modalSub').textContent = `${done.length} quemador${done.length!==1?'es':''} calibrado${done.length!==1?'s':''} · ${new Date().toLocaleDateString('es')}`;
  document.getElementById('modalTableBody').innerHTML = done.map(([id,r])=>{
    const b = burners.find(x=>x.id===id);
    const icon = r.diagClass==='diag-ok'?'✅':r.diagClass==='diag-warn'?'⚠':'🔥';
    return `<tr><td>${id}</td><td>${b?.model||'—'}</td><td>${r.dpAire}</td><td>${r.dpGas}</td><td>${Math.round(r.potencia).toLocaleString('es-AR')}</td><td>${(r.exceso*100).toFixed(1)}%</td><td>${icon}</td></tr>`;
  }).join('');
  openModal('emailModal');
}

// ══════════════════════════════════
// SHARE — Web Share API con PDF adjunto
// ══════════════════════════════════

async function shareCalibPDF() {
  if (!window.jspdf) {
    alert('📶 Requiere conexión a internet la primera vez. Conectate y recargá la página.');
    return;
  }
  const fecha = new Date().toLocaleDateString('es');
  const btn   = document.getElementById('shareCalibBtn');
  btn.textContent = '⏳ Generando PDF...';
  btn.disabled = true;

  try {
    // Generate PDF as blob
    const { jsPDF } = window.jspdf;
    const dataUri = generateCalibPDF(true);
    const base64  = dataUri.split(',')[1];
    const binary  = atob(base64);
    const bytes   = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const file = new File([blob], 'Calibracion_ECLIPSE_' + fecha.replace(/\//g,'-') + '.pdf', { type: 'application/pdf' });

    // Try native share with file
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        title:  'Informe Calibracion ECLIPSE TJ',
        text:   'Informe de calibracion del ' + fecha + ' - IGNIS',
        files:  [file]
      });
    } else if (navigator.share) {
      // Share without file (older browsers) — fallback to download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = file.name; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
      await navigator.share({
        title: 'Informe Calibracion ECLIPSE TJ',
        text:  'Informe de calibracion del ' + fecha + '. Adjuntá el PDF descargado.'
      });
    } else {
      // Desktop fallback — just download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = file.name; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
      alert('PDF descargado. En PC no hay menú nativo — adjuntalo manualmente al correo.');
    }
  } catch(e) {
    if (e.name !== 'AbortError') console.error(e);
  }

  btn.textContent = '📤 COMPARTIR PDF DE CALIBRACIÓN';
  btn.disabled = false;
  closeModal('emailModal');
}

async function shareMaintPDF() {
  if (!window.jspdf) {
    alert('📶 Requiere conexión a internet la primera vez. Conectate y recargá la página.');
    return;
  }
  const fecha = new Date().toLocaleDateString('es');
  const btn   = document.getElementById('shareMaintBtn');
  btn.textContent = '⏳ Generando PDF...';
  btn.disabled = true;

  try {
    const pdfBlob = generateMaintPDF(true);
    if (!pdfBlob) { btn.textContent = '📤 COMPARTIR PDF DE MANTENIMIENTO'; btn.disabled=false; return; }

    const file = new File([pdfBlob], 'Mantenimiento_ECLIPSE_' + fecha.replace(/\//g,'-') + '.pdf', { type:'application/pdf' });

    if (navigator.canShare && navigator.canShare({ files:[file] })) {
      await navigator.share({
        title: 'Informe Mantenimiento ECLIPSE TJ',
        text:  'Informe de mantenimiento del ' + fecha + ' - IGNIS',
        files: [file]
      });
    } else if (navigator.share) {
      const url = URL.createObjectURL(pdfBlob);
      const a = document.createElement('a'); a.href=url; a.download=file.name; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),2000);
      await navigator.share({ title:'Informe Mantenimiento ECLIPSE TJ', text:'PDF descargado. Adjuntalo al correo.' });
    } else {
      const url = URL.createObjectURL(pdfBlob);
      const a = document.createElement('a'); a.href=url; a.download=file.name; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),2000);
      alert('PDF descargado. En PC adjuntalo manualmente al correo.');
    }
  } catch(e) {
    if (e.name !== 'AbortError') console.error(e);
  }

  btn.textContent = '📤 COMPARTIR PDF DE MANTENIMIENTO';
  btn.disabled = false;
  closeModal('maintEmailModal');
}

// Wrapper: sendEmailWithPDF now uses share
function sendEmailWithPDF()     { shareCalibPDF(); }
function sendMaintEmailWithPDF(){ shareMaintPDF(); }


// ══════════════════════════════════
// HELPERS
// ══════════════════════════════════
function showView(id){ document.getElementById(id).classList.add('active'); }
function hideView(id){ document.getElementById(id).classList.remove('active'); }
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

// close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click', e=>{ if(e.target===o) o.classList.remove('open'); });
});

// ══════════════════════════════════
// MAINTENANCE EMAIL
// ══════════════════════════════════
function openMaintEmailModal() {
  const done = Object.entries(maintData);
  const fecha = new Date().toLocaleDateString('es');
  document.getElementById('maintModalSub').textContent =
    `${done.length} quemador${done.length!==1?'es':''} con registro · ${fecha}`;

  let rows = '';
  done.forEach(([burnerId, items]) => {
    const b = burners.find(x => x.id === burnerId);
    MAINT_ITEMS.forEach(item => {
      const d = items[item.id];
      if (!d) return;
      const statusIcon = d.status==='ok' ? '✅ OK' : d.status==='afectado' ? '⚠ AFECTADO' : d.status==='cambio' ? '🔄 CAMBIO' : '—';
      const inst = d.dateInst ? d.dateInst : '—';
      const camb = d.dateCamb ? d.dateCamb : '—';
      rows += `<tr>
        <td>${burnerId}</td>
        <td>${b?.model||'—'}</td>
        <td>${item.title}</td>
        <td>${statusIcon}</td>
        <td>${inst}</td>
        <td>${camb}</td>
      </tr>`;
    });
  });

  document.getElementById('maintModalTableBody').innerHTML = rows ||
    '<tr><td colspan="6" style="color:var(--muted);text-align:center;padding:12px;">Sin registros aún</td></tr>';
  openModal('maintEmailModal');
}


function sendMaintEmail() {
  const to  = document.getElementById('maintEmailTo').value.trim();
  const cc  = document.getElementById('maintEmailCc').value.trim();
  const fecha = new Date().toLocaleDateString('es');
  const hora  = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});

  const SEP  = '─────────────────────────────────────────────────────────────────────\r\n';
  const SEP2 = '·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·\r\n';

  let body = 'INFORME DE MANTENIMIENTO PREVENTIVO — ' + (appConfig.name||'IGNIS') + '\r\n';
  body += 'Fecha: ' + fecha + '  ' + hora + '\r\n';
  body += SEP;

  Object.entries(maintData).forEach(([burnerId, items]) => {
    const b = burners.find(x=>x.id===burnerId);
    body += 'QUEMADOR: ' + burnerId + '   ' + (b?.model||'—') + ' · ' + (b?.zone||'—') + '\r\n';
    body += SEP2;
    MAINT_ITEMS.forEach(item => {
      const d = items[item.id];
      if (!d) return;
      const st   = d.status==='ok'?'OK':d.status==='afectado'?'AFECTADO':d.status==='cambio'?'CAMBIO':'—';
      const inst = d.dateInst ? ('Inst: '+d.dateInst) : '';
      const camb = d.dateCamb ? ('Cambio: '+d.dateCamb) : '';
      body += '  ' + (item.title+'                                ').slice(0,32) + '  ' + st.padEnd(10) + inst.padEnd(16) + camb + '\r\n';
    });
    body += '\r\n';
  });
  body += SEP;
  body += 'Generado con IGNIS\r\n';

  const s   = encodeURIComponent('Informe Mantenimiento ECLIPSE TJ — ' + fecha);
  const bE  = encodeURIComponent(body);
  const ccP = cc ? '&cc=' + encodeURIComponent(cc) : '';
  window.location.href = 'mailto:' + encodeURIComponent(to) + '?subject=' + s + ccP + '&body=' + bE;
  closeModal('maintEmailModal');
}


// ── Visor PDF fullscreen (igual que Repuestos) ──
function showPDFViewer(blob, filename) {
  const url = URL.createObjectURL(blob);

  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#1a1a2e;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:24px;box-sizing:border-box;';

  const icon = document.createElement('div');
  icon.textContent = '📄';
  icon.style.cssText = 'font-size:64px;';

  const name = document.createElement('div');
  name.textContent = filename.replace('.pdf','').replace(/_/g,' ');
  name.style.cssText = 'color:#fff;font-size:14px;font-weight:700;font-family:monospace;text-align:center;';

  const btnDescargar = document.createElement('button');
  btnDescargar.textContent = '⬇ Descargar PDF';
  btnDescargar.style.cssText = 'padding:14px 32px;background:#e8501a;color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;width:100%;max-width:320px;';
  btnDescargar.onclick = () => {
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  const btnCerrar = document.createElement('button');
  btnCerrar.textContent = '✕ Cerrar';
  btnCerrar.style.cssText = 'padding:12px 32px;background:transparent;color:#aaa;border:1px solid #444;border-radius:12px;font-size:15px;cursor:pointer;width:100%;max-width:320px;';
  btnCerrar.onclick = () => {
    document.body.removeChild(overlay);
    URL.revokeObjectURL(url);
  };

  overlay.appendChild(icon);
  overlay.appendChild(name);
  overlay.appendChild(btnDescargar);
  overlay.appendChild(btnCerrar);
  document.body.appendChild(overlay);
}

// ══════════════════════════════════
// PDF GENERATOR — MANTENIMIENTO (blanco/profesional)
// ══════════════════════════════════
function generateMaintPDF(returnBlob) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
  const pw  = doc.internal.pageSize.getWidth();   // 297
  const ph  = doc.internal.pageSize.getHeight();  // 210
  const fecha = new Date().toLocaleDateString('es');
  const hora  = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  const appName = appConfig.name || 'IGNIS';

  let y = 0;
  let pageNum = 1;

  function addHeader() {
    // White background
    doc.setFillColor(255,255,255);
    doc.rect(0,0,pw,ph,'F');
    // Top blue strip
    doc.setFillColor(25,100,230);
    doc.rect(0,0,pw,12,'F');
    doc.setFont('helvetica','bold');
    doc.setFontSize(10);
    doc.setTextColor(255,255,255);
    doc.text(appName.toUpperCase() + ' — MANTENIMIENTO PREVENTIVO ECLIPSE TJ', 8, 8);
    doc.setFont('helvetica','normal');
    doc.setFontSize(8);
    doc.text(`${fecha}  ${hora}`, pw-8, 8, {align:'right'});
    // Footer
    doc.setFontSize(7);
    doc.setTextColor(150,150,150);
    doc.text(`Página ${pageNum}`, pw-8, ph-3, {align:'right'});
    doc.setDrawColor(200,200,200);
    doc.setLineWidth(0.2);
    doc.line(8, ph-6, pw-8, ph-6);
    y = 18;
  }

  function checkY(need) {
    if (y + need > ph - 10) {
      pageNum++;
      doc.addPage();
      addHeader();
    }
  }

  addHeader();

  // Column widths for checklist table
  const COL_ID    = 28;
  const COL_MODEL = 18;
  const COL_ITEM  = 62;
  const COL_STAT  = 22;
  const COL_INST  = 30;
  const COL_CAMB  = 30;
  const ROW_H     = 7;

  // Table header
  function drawTableHeader() {
    doc.setFillColor(235,240,255);
    doc.rect(8, y, pw-16, ROW_H, 'F');
    doc.setDrawColor(180,190,210);
    doc.setLineWidth(0.2);
    doc.rect(8, y, pw-16, ROW_H, 'S');

    doc.setFont('helvetica','bold');
    doc.setFontSize(7);
    doc.setTextColor(50,60,100);
    let cx = 10;
    doc.text('ID QUEMADOR', cx, y+5);           cx += COL_ID;
    doc.text('MODELO',      cx, y+5);            cx += COL_MODEL;
    doc.text('ÍTEM DE MANTENIMIENTO', cx, y+5);  cx += COL_ITEM;
    doc.text('ESTADO',      cx, y+5);            cx += COL_STAT;
    doc.text('F. INSTALACIÓN', cx, y+5);         cx += COL_INST;
    doc.text('F. CAMBIO',   cx, y+5);
    y += ROW_H;
  }

  drawTableHeader();

  let rowIdx = 0;
  burners.forEach(b => {
    const m = maintData[b.id] || {};

    // ── Burner title separator row ──
    checkY(8);
    doc.setFillColor(20, 60, 120);
    doc.rect(8, y, pw-16, 8, 'F');
    doc.setFont('helvetica','bold');
    doc.setFontSize(8);
    doc.setTextColor(255,255,255);
    doc.text(`${b.id}   ${b.model}  ·  ${b.zone}`, 12, y+5.5);
    y += 8;
    rowIdx = 0; // reset alternating color per burner

    // ── Photo for this burner ──
    const photo = maintPhotos[b.id];
    checkY(46);
    doc.setFillColor(235,240,255);
    doc.rect(8, y, pw-16, 6, 'F');
    doc.setFont('helvetica','bold');
    doc.setFontSize(7);
    doc.setTextColor(50,60,100);
    doc.text('Foto del quemador  -  ' + (photo && photo.date ? photo.date : ''), 11, y+4.2);
    y += 7;
    if (photo && photo.data) {
      try {
        const iw = photo.w || 800;
        const ih = photo.h || 600;
        const maxW = 70, maxH = 45;
        let rw = maxW, rh = (ih / iw) * maxW;
        if (rh > maxH) { rh = maxH; rw = (iw / ih) * maxH; }
        doc.addImage(photo.data, 'JPEG', 8, y, Math.round(rw), Math.round(rh));
        y += Math.round(rh) + 5;
      } catch(e) { y += 5; }
    } else {
      doc.setFillColor(240,242,248);
      doc.setDrawColor(200,205,220);
      doc.roundedRect(8, y, pw-16, 30, 2, 2, 'FD');
      doc.setFont('helvetica','normal');
      doc.setFontSize(8);
      doc.setTextColor(180,185,200);
      const cx = 8 + (pw-16)/2;
      doc.text('[ Sin foto ]', cx, y+16, { align:'center' });
      y += 35;
    }

    MAINT_ITEMS.forEach(mi => {
      checkY(ROW_H);

      // Row background alternating
      const bg = rowIdx % 2 === 0 ? [255,255,255] : [248,250,255];
      doc.setFillColor(...bg);
      doc.rect(8, y, pw-16, ROW_H, 'F');
      doc.setDrawColor(220,225,235);
      doc.setLineWidth(0.15);
      doc.line(8, y+ROW_H, pw-8, y+ROW_H);

      const d = m[mi.id];
      const st = d?.status;

      // Status color left bar
      if (st) {
        const sc = st==='ok'?[0,180,90]:st==='afectado'?[230,140,0]:[210,40,40];
        doc.setFillColor(...sc);
        doc.rect(8, y, 2, ROW_H, 'F');
      }

      doc.setFont('helvetica','normal');
      doc.setFontSize(7);
      doc.setTextColor(30,30,30);

      let cx = 10;
      doc.text(b.id,      cx, y+5); cx += COL_ID;
      doc.text(b.model,   cx, y+5); cx += COL_MODEL;
      doc.text(mi.title,  cx, y+5); cx += COL_ITEM;

      // Status badge
      if (st) {
        const [sc, sl] = st==='ok'   ? [[0,150,70],'OK'] :
                         st==='afectado' ? [[200,120,0],'AFECTADO'] :
                                          [[190,30,30],'CAMBIO'];
        doc.setFont('helvetica','bold');
        doc.setTextColor(...sc);
        doc.text(sl, cx, y+5);
        doc.setFont('helvetica','normal');
        doc.setTextColor(30,30,30);
      } else {
        doc.setTextColor(170,170,170);
        doc.text('-', cx, y+5);
        doc.setTextColor(30,30,30);
      }
      cx += COL_STAT;
      doc.text(d?.dateInst||'—', cx, y+5); cx += COL_INST;
      doc.text(d?.dateCamb||'—', cx, y+5);

      y += ROW_H;
      rowIdx++;

      // Re-draw header every 25 rows
      if (rowIdx % 25 === 0) {
        checkY(ROW_H);
        drawTableHeader();
      }
    });
  });

  // Outer border
  doc.setDrawColor(150,160,200);
  doc.setLineWidth(0.3);

  if (returnBlob) {
    return doc.output('blob');
  }
  const _maintFilename = 'Mantenimiento_ECLIPSE_' + fecha.replace(/\//g,'-') + '.pdf';
  showPDFViewer(doc.output('blob'), _maintFilename);
}

// ══════════════════════════════════
// PDF GENERATOR — CALIBRACIÓN (una sola hoja)
// ══════════════════════════════════
function generateCalibPDF(returnBase64) {
  if (!window.jspdf) {
    alert('📶 PDF requiere conexión a internet la primera vez. Conectate y recargá la página.');
    return null;
  }
  const { jsPDF } = window.jspdf;
  const doc    = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
  const pw     = doc.internal.pageSize.getWidth();   // 297
  const ph     = doc.internal.pageSize.getHeight();  // 210
  const fecha  = new Date().toLocaleDateString('es');
  const hora   = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  const appName = appConfig.name || 'IGNIS';

  // ── Header strip ──
  doc.setFillColor(0,150,70);
  doc.rect(0,0,pw,11,'F');
  doc.setFont('helvetica','bold');
  doc.setFontSize(9);
  doc.setTextColor(255,255,255);
  doc.text(appName.toUpperCase() + ' - INFORME DE CALIBRACION ECLIPSE TJ', 7, 7.5);
  doc.setFont('helvetica','normal');
  doc.setFontSize(7.5);
  doc.text(fecha + '  ' + hora, pw-7, 7.5, {align:'right'});

  // ── Summary bar ──
  const done    = Object.keys(readings).length;
  const optimos = Object.values(readings).filter(r=>r.diagClass==='diag-ok').length;
  const alertas = done - optimos;
  let y = 13;
  doc.setFillColor(240,250,244);
  doc.rect(7, y, pw-14, 8, 'F');
  doc.setDrawColor(170,210,180);
  doc.setLineWidth(0.2);
  doc.rect(7, y, pw-14, 8, 'S');
  doc.setFont('helvetica','bold');
  doc.setFontSize(7);
  doc.setTextColor(30,30,30);
  doc.text('Total: ' + burners.length, 11, y+5.5);
  doc.setTextColor(0,130,60);
  doc.text('Calibrados: ' + done, 50, y+5.5);
  doc.text('Optimos: ' + optimos, 100, y+5.5);
  if (alertas > 0) doc.setTextColor(200,100,0); else doc.setTextColor(150,150,150);
  doc.text('Alertas: ' + alertas, 160, y+5.5);
  doc.setTextColor(100,100,100);
  doc.text('Pendientes: ' + (burners.length - done), 220, y+5.5);
  y += 10;

  // ── Columns ──
  const COLS = [
    { lbl:'ID QUEMADOR',   w:27 },
    { lbl:'ZONA',          w:20 },
    { lbl:'MODELO',        w:14 },
    { lbl:'PO AIRE mm',    w:17 },
    { lbl:'PO GAS mm',     w:16 },
    { lbl:'dP AIRE mbar',  w:17 },
    { lbl:'dP GAS mbar',   w:16 },
    { lbl:'POTENCIA BTU/h',w:26 },
    { lbl:'% EXCESO',      w:16 },
    { lbl:'DIAGNOSTICO',   w:26 },
    { lbl:'CONSUMO m3/h',  w:20 },
    { lbl:'FECHA',         w:18 },
    { lbl:'% CARGA',       w:14 },
  ];
  const ROW_H = 5.5;
  const HDR_H = 8;

  // Column header
  doc.setFillColor(0,100,50);
  doc.rect(7, y, pw-14, HDR_H, 'F');
  doc.setFont('helvetica','bold');
  doc.setFontSize(6);
  doc.setTextColor(255,255,255);
  let cx = 9;
  COLS.forEach(col => { doc.text(col.lbl, cx, y+5); cx += col.w; });
  y += HDR_H;

  // Rows
  burners.forEach((b, idx) => {
    const r = readings[b.id];
    const c = COEF[b.model];

    // Alternating bg
    doc.setFillColor(...(idx%2===0?[255,255,255]:[244,250,246]));
    doc.rect(7, y, pw-14, ROW_H, 'F');

    // Status bar left
    if (r) {
      const sc = r.diagClass==='diag-ok'?[0,180,90]:r.diagClass==='diag-warn'?[230,140,0]:[210,40,40];
      doc.setFillColor(...sc);
      doc.rect(7, y, 1.5, ROW_H, 'F');
    }

    // Row separator
    doc.setDrawColor(210,230,215);
    doc.setLineWidth(0.1);
    doc.line(7, y+ROW_H, pw-7, y+ROW_H);

    const btu = r ? Math.round(r.potencia).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.') : '—';
    const vals = [
      b.id, b.zone, b.model,
      c ? String(c.maxAire) : '—',
      c ? String(c.maxGas)  : '—',
      r ? String(r.dpAire)  : '—',
      r ? String(r.dpGas)   : '—',
      btu,
      r ? (r.exceso*100).toFixed(1)+'%' : '—',
      r ? (r.diagClass==='diag-ok'?'OPTIMO':r.diagClass==='diag-warn'?'MUCHO AIRE':'MUCHO GAS') : 'Pendiente',
      r ? r.flujoGas.toFixed(2) : '—',
      r ? (r.date||'—')   : '—',
      r ? (r.carga*100).toFixed(0)+'%' : '—',
    ];

    doc.setFont('helvetica','normal');
    doc.setFontSize(6.2);
    cx = 9;
    vals.forEach((val, i) => {
      if (i===9 && r) {
        const sc = r.diagClass==='diag-ok'?[0,140,60]:r.diagClass==='diag-warn'?[200,100,0]:[190,30,30];
        doc.setFont('helvetica','bold');
        doc.setTextColor(...sc);
        doc.text(val, cx, y+3.8);
        doc.setFont('helvetica','normal');
        doc.setTextColor(30,30,30);
      } else if (!r && i > 4) {
        doc.setTextColor(170,170,170);
        doc.text(val, cx, y+3.8);
        doc.setTextColor(30,30,30);
      } else {
        doc.setTextColor(30,30,30);
        doc.text(val, cx, y+3.8);
      }
      cx += COLS[i].w;
    });
    y += ROW_H;
  });

  // Footer line
  doc.setDrawColor(180,210,180);
  doc.setLineWidth(0.3);
  doc.line(7, y+2, pw-7, y+2);
  doc.setFontSize(6);
  doc.setTextColor(150,150,150);
  doc.text('Generado con IGNIS - ECLIPSE TJ', pw/2, y+6, {align:'center'});

  if (returnBase64) {
    return doc.output('datauristring');
  }
  const _calibFilename = 'Calibracion_ECLIPSE_' + fecha.replace(/\//g,'-') + '.pdf';
  showPDFViewer(doc.output('blob'), _calibFilename);
  return null;
}



// ══════════════════════════════════
// STOCK — CATÁLOGO + INVENTARIO
// ══════════════════════════════════

// Real Eclipse ThermJet spare parts from Installation Guide 205
const CATALOG = [
  // ── Partes comunes TJ 015 / TJ 025 / TJ 040 ──
  { part:'17054',      desc:'Gasket, Mounting',              models:['TJ 015','TJ 025','TJ 040'], cat:'Juntas' },
  { part:'16022',      desc:'Screw M8x16',                   models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Ferretería' },
  { part:'14778',      desc:'O-ring',                        models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Juntas' },
  { part:'10005',      desc:'Silicon Carbide Gasket',        models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Juntas' },
  { part:'15885',      desc:'Set Screw M6x10',               models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Ferretería' },
  { part:'13445',      desc:'Pressure Tap',                  models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Instrumentación' },
  { part:'18720',      desc:'UV Scanner Adapter',            models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Detección de llama' },
  { part:'10002242-2', desc:'Flamerod (sonda de llama)',     models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Detección de llama' },
  { part:'10003',      desc:'Retaining Ring, SiC',           models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Combustor' },
  { part:'10509',      desc:'Peepsight (mirilla)',           models:['TJ 015','TJ 025','TJ 040','TJ 075'], cat:'Accesorios' },
  // ── Cuerpos (Body) ──
  { part:'7031-1',     desc:'Body — Cuerpo del quemador',   models:['TJ 015','TJ 025'],          cat:'Cuerpo' },
  { part:'7118-1',     desc:'Body — Cuerpo del quemador',   models:['TJ 040'],                   cat:'Cuerpo' },
  { part:'7046-1',     desc:'Body — Cuerpo del quemador',   models:['TJ 075'],                   cat:'Cuerpo' },
  // ── Boquillas Cast Iron ──
  { part:'7033-1',     desc:'Nozzle, Cast Iron',            models:['TJ 015'],                   cat:'Boquilla' },
  { part:'7033-2',     desc:'Nozzle, Cast Iron',            models:['TJ 025'],                   cat:'Boquilla' },
  { part:'7033-3',     desc:'Nozzle, Cast Iron',            models:['TJ 040'],                   cat:'Boquilla' },
  { part:'7133-2',     desc:'Nozzle, Cast Iron',            models:['TJ 075'],                   cat:'Boquilla' },
  // ── Boquillas Stainless Steel ──
  { part:'7125-1',     desc:'Nozzle, Stainless Steel',      models:['TJ 015'],                   cat:'Boquilla' },
  { part:'7135-1',     desc:'Nozzle, Stainless Steel',      models:['TJ 025'],                   cat:'Boquilla' },
  { part:'7125-2',     desc:'Nozzle, Stainless Steel',      models:['TJ 040'],                   cat:'Boquilla' },
  { part:'7137-1',     desc:'Nozzle, Stainless Steel',      models:['TJ 075'],                   cat:'Boquilla' },
  // ── Boquillas para Flamerod Cast Iron ──
  { part:'10026919',   desc:'Nozzle for Flamerod, Cast Iron', models:['TJ 015'],                 cat:'Boquilla' },
  { part:'10026920',   desc:'Nozzle for Flamerod, Cast Iron', models:['TJ 025'],                 cat:'Boquilla' },
  { part:'10026921',   desc:'Nozzle for Flamerod, Cast Iron', models:['TJ 040'],                 cat:'Boquilla' },
  { part:'10026924',   desc:'Nozzle for Flamerod, Cast Iron', models:['TJ 075'],                 cat:'Boquilla' },
  // ── Boquillas para Flamerod Stainless ──
  { part:'10026926',   desc:'Nozzle for Flamerod, Stainless', models:['TJ 015'],                 cat:'Boquilla' },
  { part:'10026927',   desc:'Nozzle for Flamerod, Stainless', models:['TJ 025'],                 cat:'Boquilla' },
  { part:'10026928',   desc:'Nozzle for Flamerod, Stainless', models:['TJ 040'],                 cat:'Boquilla' },
  { part:'10026930',   desc:'Nozzle for Flamerod, Stainless', models:['TJ 075'],                 cat:'Boquilla' },
  // ── Spark Plug ──
  { part:'10019728',   desc:'Spark Plug (bujía de encendido)', models:['TJ 075'],                cat:'Encendido' },
  // ── Orifice Plates — Gas Natural ──
  { part:'14188-3',    desc:'Orifice Plate Gas Natural 10mm', models:['TJ 015'],                 cat:'Placa orificio' },
  { part:'14188-5',    desc:'Orifice Plate Gas Natural 13mm', models:['TJ 025'],                 cat:'Placa orificio' },
  { part:'14188-6',    desc:'Orifice Plate Gas Natural 15mm', models:['TJ 040'],                 cat:'Placa orificio' },
  { part:'14188-9',    desc:'Orifice Plate Gas Natural 20mm', models:['TJ 075'],                 cat:'Placa orificio' },
  // ── Orifice Plates — Aire ──
  { part:'14802-5',    desc:'Orifice Plate Air 36mm',         models:['TJ 015'],                 cat:'Placa orificio' },
  { part:'14802-6',    desc:'Orifice Plate Air 44mm',         models:['TJ 025'],                 cat:'Placa orificio' },
  { part:'14802-7',    desc:'Orifice Plate Air 52mm',         models:['TJ 040'],                 cat:'Placa orificio' },
  { part:'14802-3',    desc:'Orifice Plate Air 66mm',         models:['TJ 075'],                 cat:'Placa orificio' },
  // ── Combustores ──
  { part:'187296-68',  desc:'Block & Holder Assembly HV',    models:['TJ 015','TJ 025'],          cat:'Combustor' },
  { part:'187297-68',  desc:'Block & Holder Assembly MV',    models:['TJ 015','TJ 025'],          cat:'Combustor' },
  { part:'187298-68',  desc:'Block & Holder Assembly HV',    models:['TJ 040'],                   cat:'Combustor' },
  { part:'187299-68',  desc:'Block & Holder Assembly MV',    models:['TJ 040'],                   cat:'Combustor' },
  { part:'187302-68',  desc:'Block & Holder Assembly HV',    models:['TJ 075'],                   cat:'Combustor' },
  { part:'187300-68',  desc:'Block & Holder Assembly MV',    models:['TJ 075'],                   cat:'Combustor' },
  // ── Montaje ──
  { part:'20422',      desc:'Gasket, Mounting',              models:['TJ 075'],                   cat:'Juntas' },
];

let inventory = JSON.parse(localStorage.getItem('cb_inventory') || '[]');
let currentCatalogFilter = 'TJ 015';
let hiddenCatalog = JSON.parse(localStorage.getItem('cb_hidden') || '{}');

function persistInventory() {
  localStorage.setItem('cb_inventory', JSON.stringify(inventory));
  // Sincronizar con Firebase
  if (window._fbReady) {
    const ts = Date.now();
    window._lastSaveTs = ts;
    const docRef = window._fbDoc(window._fbDb, 'ignis', 'datos');
    window._fbSetDoc(docRef, { inventory, _ts: ts }, { merge: true })
      .catch(e => console.warn('Firebase inventory sync error:', e));
  }
}

// ── Stock password ──
const DEFAULT_STOCK_PASS = '2042';

function showStockLock() {
  document.getElementById('stockLock').style.display    = 'flex';
  document.getElementById('stockContent').style.display = 'none';
  document.getElementById('stockPassInput').value = '';
  setTimeout(() => document.getElementById('stockPassInput').focus(), 300);
}

function checkStockPass() {
  const val     = document.getElementById('stockPassInput').value.trim();
  const stored  = appConfig.stockPassword || DEFAULT_STOCK_PASS;
  if (val === stored) {
    document.getElementById('stockLock').style.display    = 'none';
    document.getElementById('stockContent').style.display = 'flex';
    document.getElementById('stockContent').style.flexDirection = 'column';
    document.getElementById('stockContent').style.height = '100%';
    switchStockTab('list');
  } else {
    document.getElementById('stockPassInput').style.borderColor = 'var(--danger)';
    document.getElementById('stockPassInput').value = '';
    document.getElementById('stockPassInput').placeholder = 'Clave incorrecta...';
    setTimeout(() => {
      document.getElementById('stockPassInput').style.borderColor = 'var(--border2)';
      document.getElementById('stockPassInput').placeholder = 'Clave de acceso';
    }, 1500);
  }
}

let currentInventoryFilter = null;

function switchStockTab(tab) {
  ['stab-list','stab-add'].forEach((id,i) =>
    document.getElementById(id)?.classList.toggle('active', (i===0&&tab==='list')||(i===1&&tab==='add')));
  ['sv-inventory','sv-addform'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
  if (tab==='list') {
    document.getElementById('sv-inventory')?.classList.add('active');
    filterInventory(currentInventoryFilter);
  }
  if (tab==='add') {
    document.getElementById('sv-addform')?.classList.add('active');
    // Pre-select current model filter
    const sel = document.getElementById('sModelSel');
    if (sel) sel.value = currentInventoryFilter === 'TODOS' ? 'TODOS' : currentInventoryFilter;
  }
}

function filterInventory(model) {
  currentInventoryFilter = model;
  ['si015','si025','si040','si075','siGEN'].forEach(id =>
    document.getElementById(id)?.classList.remove('sel-ok'));
  const map = { 'TJ 015':'si015','TJ 025':'si025','TJ 040':'si040','TJ 075':'si075', 'TODOS':'siGEN' };
  if (model) document.getElementById(map[model])?.classList.add('sel-ok');
  renderInventory();
}


function filterCatalog(model) {
  currentCatalogFilter = model;
  ['f015','f025','f040','f075'].forEach(id => {
    document.getElementById(id)?.classList.remove('sel-ok');
  });
  const map = { 'TJ 015':'f015','TJ 025':'f025','TJ 040':'f040','TJ 075':'f075' };
  document.getElementById(map[model])?.classList.add('sel-ok');
  renderCatalog();
}

function renderCatalog() {
  const model = currentCatalogFilter;
  const filtered = CATALOG.filter(p =>
    p.models.includes(model) &&
    !(hiddenCatalog[model] || []).includes(p.part)
  );
  const cats = [...new Set(filtered.map(p => p.cat))];
  let html = '';

  if (!filtered.length) {
    const hiddenCount = (hiddenCatalog[model] || []).length;
    html = `<div class="empty"><div class="empty-icon">📦</div>
      <div class="empty-text">Sin repuestos visibles para ${model}.<br>
      ${hiddenCount > 0 ? `<span style="color:var(--muted);font-size:11px;">${hiddenCount} oculto${hiddenCount!==1?'s':''}.</span>` : ''}
      </div></div>
      ${hiddenCount > 0 ? `<button class="btn-secondary" onclick="restoreAllCatalog()" style="margin-top:8px;font-size:12px;color:var(--muted2);">↩ Restaurar ocultos</button>` : ''}`;
    document.getElementById('catalogList').innerHTML = html;
    return;
  }

  cats.forEach(cat => {
    const items = filtered.filter(p => p.cat === cat);
    html += `<div class="zone-label">${cat}</div>`;
    items.forEach(p => {
      const inStock  = inventory.findIndex(i => i.part === p.part);
      const hasStock = inStock >= 0;
      const safeDesc = p.desc.replace(/'/g,"\\'");
      // Long press data stored in data attributes — no inline handlers that conflict
      html += `
      <div class="burner-card lp-card"
        data-part="${p.part}" data-desc="${safeDesc}"
        style="--bc:${hasStock?'var(--ok)':'var(--border)'};user-select:none;">
        <div style="flex:1">
          <div style="font-size:12px;font-weight:700;font-family:var(--font-m);color:var(--ok);letter-spacing:0.5px;margin-bottom:2px;">${p.part}</div>
          <div style="font-size:13px;color:var(--text);font-weight:500;">${p.desc}</div>
          ${hasStock ? `<div style="font-size:10px;color:var(--ok);font-family:var(--font-m);margin-top:3px;">&#10003; En stock: ${inventory[inStock].qty} ud.</div>` : ''}
          <div class="lp-hint" style="font-size:9px;color:var(--danger);font-family:var(--font-m);margin-top:4px;opacity:0;transition:opacity 0.15s;">Mantené presionado para ocultar...</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;flex-shrink:0;">
          ${hasStock
            ? `<div style="display:flex;gap:4px;align-items:center;">
                <button class="lp-stop" onclick="changeQty(${inStock},-1)" style="width:26px;height:26px;border-radius:7px;border:1px solid var(--border2);background:var(--card);color:var(--text);cursor:pointer;font-size:14px;">&#8722;</button>
                <span style="width:22px;text-align:center;font-family:var(--font-m);font-size:13px;font-weight:700;">${inventory[inStock].qty}</span>
                <button class="lp-stop" onclick="changeQty(${inStock},+1)" style="width:26px;height:26px;border-radius:7px;border:1px solid var(--border2);background:var(--card);color:var(--text);cursor:pointer;font-size:14px;">&#xFF0B;</button>
              </div>
              <button class="lp-stop" onclick="deleteInventoryItem(${inStock},true)" style="font-size:9px;color:var(--danger);background:none;border:none;cursor:pointer;font-family:var(--font-m);">QUITAR</button>`
            : `<button class="lp-stop" onclick="addFromCatalog('${p.part}','${safeDesc}','${model}')"
                style="background:rgba(68,138,255,0.1);border:1px solid rgba(68,138,255,0.3);color:var(--blue);
                border-radius:8px;padding:6px 12px;font-size:11px;font-weight:700;
                cursor:pointer;font-family:var(--font-d);white-space:nowrap;">&#xFF0B; AGREGAR</button>`
          }
        </div>
      </div>`;
    });
  });
  document.getElementById('catalogList').innerHTML = html;

  // Show restore button if there are hidden items for this model
  const hiddenCount = (hiddenCatalog[model] || []).length;
  if (hiddenCount > 0) {
    document.getElementById('catalogList').innerHTML +=
      `<div style="text-align:center;margin-top:12px;">
        <button class="btn-secondary" onclick="restoreAllCatalog()"
          style="font-size:11px;color:var(--muted);padding:8px 18px;border-color:var(--border2);">
          ↩ ${hiddenCount} oculto${hiddenCount!==1?'s':''} — Restaurar todos
        </button>
      </div>`;
  }
}

function addFromCatalog(part, desc, modelsStr) {
  const existing = inventory.find(i => i.part === part);
  if (existing) {
    existing.qty = (existing.qty||1) + 1;
  } else {
    inventory.push({ part, desc, models: modelsStr, qty:1, supplier:'Eclipse' });
  }
  persistInventory();
  renderCatalog();
}

// ── Long Press — ocultar repuesto del catálogo ──
// Attach after render via event delegation on catalogList
(function initLongPress() {
  let lpTimer = null;
  let lpTarget = null;

  function getCard(el) {
    // Walk up to find .lp-card
    while (el && !el.classList?.contains('lp-card')) el = el.parentElement;
    return el;
  }

  function startLP(e) {
    // If touch/click on a button (.lp-stop), don't trigger long press
    if (e.target.closest('.lp-stop')) return;
    const card = getCard(e.target);
    if (!card) return;
    lpTarget = card;
    const hint = card.querySelector('.lp-hint');
    if (hint) hint.style.opacity = '1';

    lpTimer = setTimeout(() => {
      if (!lpTarget) return;
      if (navigator.vibrate) navigator.vibrate([40, 30, 80]);
      // Flash red
      card.style.transition = 'outline 0s';
      card.style.outline = '2px solid rgba(210,40,40,0.6)';
      setTimeout(() => { card.style.outline = ''; }, 400);
      if (hint) hint.style.opacity = '0';
      lpTarget = null;
      // Open confirm modal — pass model too so it hides per model
      const part = card.dataset.part;
      const desc = card.dataset.desc;
      document.getElementById('delCatPart').textContent = part;
      document.getElementById('delCatDesc').textContent = desc;
      window._pendingDelPart = part;
      window._pendingDelModel = currentCatalogFilter;
      openModal('delCatModal');
    }, 650);
  }

  function cancelLP() {
    if (lpTimer) { clearTimeout(lpTimer); lpTimer = null; }
    if (lpTarget) {
      const hint = lpTarget.querySelector('.lp-hint');
      if (hint) hint.style.opacity = '0';
      lpTarget = null;
    }
  }

  // Attach to the catalogList container (event delegation — works after re-render)
  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('catalogList');
    if (!list) return;
    list.addEventListener('mousedown',  startLP);
    list.addEventListener('touchstart', startLP, { passive: true });
    list.addEventListener('mouseup',    cancelLP);
    list.addEventListener('mouseleave', cancelLP);
    list.addEventListener('touchend',   cancelLP);
    list.addEventListener('touchmove',  cancelLP, { passive: true });
    // Prevent context menu on long press (mobile)
    list.addEventListener('contextmenu', e => e.preventDefault());
  });
})();

function confirmDeleteCatalog() {
  const part  = window._pendingDelPart;
  const model = window._pendingDelModel || currentCatalogFilter;
  if (!part) return;
  // Hide only for the specific model selected
  if (!hiddenCatalog[model]) hiddenCatalog[model] = [];
  if (!hiddenCatalog[model].includes(part)) hiddenCatalog[model].push(part);
  localStorage.setItem('cb_hidden', JSON.stringify(hiddenCatalog));
  closeModal('delCatModal');
  renderCatalog();
}

function restoreAllCatalog() {
  if (!confirm('Restaurar todos los articulos ocultos de ' + currentCatalogFilter + '?')) return;
  delete hiddenCatalog[currentCatalogFilter];
  localStorage.setItem('cb_hidden', JSON.stringify(hiddenCatalog));
  renderCatalog();
}


function showAddInventory() {
  document.getElementById('addFormTitle').textContent = 'Agregar Repuesto';
  ['sPartNum','sDesc','sQty','sSupplier'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('sv-inventory').classList.remove('active');
  document.getElementById('sv-addform').classList.add('active');
  document.querySelectorAll('#stockScreen .tab-btn').forEach(b => b.classList.remove('active'));
}

// ── Stock photo handlers ──
let pendingStockPhoto = null;

function handleStockPhoto(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      // Resize to max 600px
      const MAX = 600;
      let w = img.width, h = img.height;
      if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
      if (h > MAX) { w = Math.round(w * MAX / h); h = MAX; }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const data = canvas.toDataURL('image/jpeg', 0.70);
      pendingStockPhoto = { data, w, h };
      // Show preview
      document.getElementById('stockPhotoImg').src = data;
      document.getElementById('stockPhotoPreview').style.display = 'block';
      document.getElementById('stockPhotoEmpty').style.display = 'none';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function removeStockPhoto() {
  pendingStockPhoto = null;
  document.getElementById('stockPhotoImg').src = '';
  document.getElementById('stockPhotoPreview').style.display = 'none';
  document.getElementById('stockPhotoEmpty').style.display = 'flex';
}

function saveInventoryItem() {
  // Si estamos editando, actualizar en lugar de agregar
  if (window._editingIdx !== undefined && window._editingIdx !== null) {
    const idx = window._editingIdx;
    const model = document.getElementById('sModel').value;
    const part  = document.getElementById('sPart').value.trim();
    const desc  = document.getElementById('sDesc').value.trim();
    const brand = document.getElementById('sBrand').value.trim();
    const supp  = document.getElementById('sSupplier').value.trim();
    const qty   = parseInt(document.getElementById('sQty').value) || 1;
    if (!part || !desc) { alert('N° de pieza y descripción son obligatorios.'); return; }
    inventory[idx] = { ...inventory[idx], models:model, part, desc, brand, qty, supplier:supp };
    // Foto
    const prev = document.getElementById('photoPreview');
    if (prev && prev.src && prev.src !== window.location.href) {
      inventory[idx].photo = { data: prev.src };
    }
    persistInventory();
    window._editingIdx = null;
    // Resetear botón
    const btn = document.querySelector('#inv-add .btn-primary');
    if (btn) btn.textContent = 'GUARDAR';
    // Volver al inventario
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-btn')[0]?.classList.add('active');
    hideView('inv-add'); showView('inv-list');
    currentInventoryFilter = model === 'TODOS' ? 'TODOS' : model;
    filterInventory(currentInventoryFilter);
    return;
  }
  // === AGREGAR NUEVO ===
  const part     = document.getElementById('sPartNum').value.trim();
  const desc     = document.getElementById('sDesc').value.trim();
  const model    = document.getElementById('sModelSel').value;
  const qty      = parseInt(document.getElementById('sQty').value)||1;
  const brand    = document.getElementById('sBrand').value.trim() || 'ECLIPSE';
  const supplier = document.getElementById('sSupplier').value.trim();
  if (!part && !desc) { alert('Ingresa al menos N de pieza o descripcion'); return; }
  inventory.push({ part, desc, models: model, qty, brand, supplier, photo: pendingStockPhoto || null });
  persistInventory();
  currentInventoryFilter = model;
  // Clear form
  ['sPartNum','sDesc','sSupplier'].forEach(id => document.getElementById(id).value='');
  document.getElementById('sQty').value = '1';
  document.getElementById('sBrand').value = 'ECLIPSE';
  // Reset photo
  removeStockPhoto();
  switchStockTab('list');
}

function renderInventory() {
  const el = document.getElementById('inventoryList');
  const model = currentInventoryFilter;
  if (!model) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">📦</div><div class="empty-text">Seleccioná un modelo o GENERAL para ver los repuestos.</div></div>';
    return;
  }
  const filtered = inventory.map((s,i) => ({...s, _idx:i}))
                             .filter(s => model === 'TODOS' ? s.models === 'TODOS' : s.models === model);

  if (!filtered.length) {
    const total = inventory.length;
    el.innerHTML = `<div class="empty"><div class="empty-icon">📦</div>
      <div class="empty-text">Sin repuestos para ${model}.<br>
      ${total > 0 ? '<span style="font-size:11px;color:var(--muted);">Hay '+total+' repuesto'+(total!==1?'s':'')+' en otros modelos.</span>' : 'Tocá ＋ AGREGAR para cargar el primero.'}
      </div></div>`;
    return;
  }
  el.innerHTML = filtered.map(s => `
    <div class="burner-card" style="--bc:var(--ok);flex-direction:row;gap:0;padding:12px 14px;align-items:stretch;cursor:pointer;"
      oncontextmenu="event.preventDefault();editInventoryItem(${s._idx})"
      ontouchstart="startLongPress(${s._idx},event)" ontouchend="cancelLongPress()" ontouchmove="cancelLongPress()">
      <!-- FOTO CUADRADA IZQUIERDA -->
      <div style="width:72px;height:72px;flex-shrink:0;border-radius:10px;overflow:hidden;margin-right:12px;background:#1e1e2e;border:1px dashed var(--border2);display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="promptAddPhoto(${s._idx})">
        ${s.photo
          ? `<img src="${s.photo.data}" style="width:100%;height:100%;object-fit:contain;">`
          : `<div style="text-align:center;color:var(--muted);font-size:9px;font-family:var(--font-m);line-height:1.4;">📷<br>Agregar<br>foto</div>`
        }
      </div>
      <!-- CONTENIDO DERECHA -->
      <div style="flex:1;min-width:0;display:flex;flex-direction:column;justify-content:space-between;">
        <!-- FILA SUPERIOR: info + cantidad -->
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;">
          <div style="min-width:0;">
            <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);margin-bottom:2px;">
              N° <span style="color:var(--ok);font-weight:700;">${s.part||'—'}</span>
              &nbsp;<span style="background:rgba(68,138,255,0.12);color:var(--blue);font-size:9px;padding:2px 6px;border-radius:10px;">${s.models||model}</span>
            </div>
            <div style="font-size:13px;color:var(--text);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${s.desc||'—'}</div>
            <div style="font-size:10px;color:var(--muted);font-family:var(--font-m);margin-top:2px;">
              Marca: <span style="color:var(--text);">${s.brand||'ECLIPSE'}</span>${s.supplier ? ' &nbsp;·&nbsp; Prov: <span style="color:var(--text);">'+s.supplier+'</span>' : ''}
            </div>
          </div>
          <!-- +/- ARRIBA DERECHA -->
          <div style="display:flex;gap:4px;align-items:center;flex-shrink:0;">
            <button onclick="changeQty(${s._idx},-1)" style="width:28px;height:28px;border-radius:7px;border:1px solid var(--border2);background:var(--card);color:var(--text);cursor:pointer;font-size:16px;">&#8722;</button>
            <span style="width:28px;text-align:center;line-height:28px;font-family:var(--font-m);font-size:14px;font-weight:700;">${s.qty||1}</span>
            <button onclick="changeQty(${s._idx},+1)" style="width:28px;height:28px;border-radius:7px;border:1px solid var(--border2);background:var(--card);color:var(--text);cursor:pointer;font-size:16px;">&#xFF0B;</button>
          </div>
        </div>
        <!-- FILA INFERIOR: ELIMINAR bien abajo a la derecha -->
        <div style="display:flex;justify-content:flex-end;margin-top:8px;">
          <button onclick="deleteInventoryItem(${s._idx})" style="font-size:10px;color:var(--danger);background:none;border:1px solid var(--danger);border-radius:6px;padding:4px 12px;cursor:pointer;font-family:var(--font-m);">ELIMINAR</button>
        </div>
      </div>
    </div>`).join('');
}

function changeQty(idx, delta) {
  inventory[idx].qty = Math.max(0, (inventory[idx].qty||1) + delta);
  if (inventory[idx].qty === 0) {
    if (!confirm('Quitar este repuesto del inventario?')) { inventory[idx].qty = 1; persistInventory(); renderInventory(); return; }
    inventory.splice(idx, 1);
  }
  persistInventory();
  renderInventory();
}


// ── Long press para editar repuesto ──
let _lpTimer = null;
function startLongPress(idx, e) {
  _lpTimer = setTimeout(() => { editInventoryItem(idx); }, 600);
}
function cancelLongPress() {
  if (_lpTimer) { clearTimeout(_lpTimer); _lpTimer = null; }
}

function editInventoryItem(idx) {
  const s = inventory[idx];
  if (!s) return;
  // Poblar formulario de agregar con los datos existentes
  document.getElementById('sModel').value   = s.models || '';
  document.getElementById('sPart').value    = s.part   || '';
  document.getElementById('sDesc').value    = s.desc   || '';
  document.getElementById('sBrand').value   = s.brand  || '';
  document.getElementById('sSupplier').value= s.supplier|| '';
  document.getElementById('sQty').value     = s.qty    || 1;
  // Mostrar foto si tiene
  if (s.photo) {
    const prev = document.getElementById('photoPreview');
    if (prev) { prev.src = s.photo.data; prev.style.display='block'; }
  }
  // Guardar índice para update
  window._editingIdx = idx;
  // Ir a pestaña agregar
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-btn')[1]?.classList.add('active');
  hideView('inv-list'); showView('inv-add');
  // Cambiar texto del botón
  const btn = document.querySelector('#inv-add .btn-primary');
  if (btn) btn.textContent = 'ACTUALIZAR';
}

function deleteInventoryItem(idx, fromCatalog=false) {
  if (!confirm('¿Quitar este repuesto del inventario?')) return;
  inventory.splice(idx, 1);
  persistInventory();
  if (fromCatalog) renderCatalog();
  else renderInventory();
}


function promptAddPhoto(idx) {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      inventory[idx].photo = { data: ev.target.result };
      persistInventory();
      renderInventory();
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function generateInventoryPDF() {
  const fecha = new Date().toLocaleDateString('es');
  const hora  = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  const nombre = appConfig.name || 'IGNIS';
  const modelos = ['TJ 015','TJ 025','TJ 040','TJ 075','TODOS'];
  let rows = '';
  modelos.forEach(mod => {
    const items = mod === 'TODOS' ? inventory.filter(s => s.models === 'TODOS') : inventory.filter(s => s.models === mod);
    if (!items.length) return;
    const label = mod === 'TODOS' ? 'GENERALES' : mod;
    // Título de sección suave (azul oscuro claro)
    rows += `<tr><td colspan="6" style="background:#2c3e6b;color:#fff;padding:7px 10px;font-weight:700;font-size:12px;letter-spacing:1px;">${label}</td></tr>`;
    rows += items.map(s => {
      const fotoCell = s.photo
        ? `<td style="padding:4px 8px;width:48px;"><img src="${s.photo.data}" style="width:44px;height:44px;object-fit:contain;border-radius:4px;background:#f5f5f5;display:block;"></td>`
        : `<td style="padding:4px 8px;width:48px;text-align:center;color:#ccc;font-size:16px;">📷</td>`;
      return `<tr>
        ${fotoCell}
        <td>${s.part||'—'}</td>
        <td><strong>${s.desc||'—'}</strong></td>
        <td>${s.brand||'ECLIPSE'}</td>
        <td>${s.supplier||'—'}</td>
        <td style="text-align:center;font-weight:700;color:#1a7a4a;">${s.qty||1}</td>
      </tr>`;
    }).join('');
  });
  if (!rows) { alert('No hay repuestos en el inventario.'); return; }
  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Stock Repuestos</title>
  <style>
    body{font-family:Arial,sans-serif;font-size:12px;color:#111;padding:24px;margin:0;}
    h1{font-size:17px;margin:0 0 3px;}
    .sub{color:#666;font-size:10px;margin-bottom:18px;}
    table{width:100%;border-collapse:collapse;}
    th{background:#f0f0f0;color:#555;font-size:10px;text-align:left;padding:6px 8px;border-bottom:2px solid #ddd;}
    td{padding:5px 8px;border-bottom:1px solid #eee;font-size:11px;vertical-align:middle;}
    .footer{margin-top:20px;font-size:10px;color:#aaa;text-align:center;}
    @media print{body{padding:10px;}}
  </style>
</head><body>
  <h1>📦 Stock de Repuestos — ${nombre}</h1>
  <div class="sub">Generado: ${fecha} ${hora}</div>
  <table>
    <thead><tr><th style="width:48px;">Foto</th><th>N° Pieza</th><th>Descripción</th><th>Marca</th><th>Proveedor</th><th style="text-align:center;">Cant.</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
  <div class="footer">— Generado con IGNIS —</div>
  <script>// print handled by parent<\/script>
  </body></html>`;

  // Crear iframe temporal para mostrar PDF
  const blob = new Blob([html], {type:'text/html'});
  const url  = URL.createObjectURL(blob);
  
  // Crear iframe fullscreen con barra de botones
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;display:flex;flex-direction:column;background:#fff;';

  // Barra superior
  const bar = document.createElement('div');
  bar.style.cssText = 'display:flex;align-items:center;padding:8px 12px;background:#1a1a2e;gap:10px;flex-shrink:0;';

  const title = document.createElement('div');
  title.textContent = '📦 Stock de Repuestos';
  title.style.cssText = 'color:#fff;font-size:13px;font-weight:700;flex:1;font-family:monospace;';

  const btnDesc = document.createElement('button');
  btnDesc.textContent = '⬇ Descargar';
  btnDesc.style.cssText = 'padding:8px 14px;background:#e8501a;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;flex-shrink:0;';
  btnDesc.onclick = () => {
    const a = document.createElement('a');
    a.href = url; a.download = 'stock_repuestos.html';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  const btnClose = document.createElement('button');
  btnClose.textContent = '✕ Cerrar';
  btnClose.style.cssText = 'padding:8px 14px;background:#ff4444;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;flex-shrink:0;';
  btnClose.onclick = () => {
    document.body.removeChild(overlay);
    URL.revokeObjectURL(url);
  };

  bar.appendChild(title);
  bar.appendChild(btnDesc);
  bar.appendChild(btnClose);

  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'flex:1;width:100%;border:none;';
  iframe.src = url;

  overlay.appendChild(bar);
  overlay.appendChild(iframe);
  document.body.appendChild(overlay);
}

function openStockEmailModal() {
  const fecha = new Date().toLocaleDateString('es');
  document.getElementById('stockEmailSub').textContent =
    `${inventory.length} repuesto${inventory.length!==1?'s':''} en inventario · ${fecha}`;
  document.getElementById('stockEmailBody').innerHTML = inventory.length
    ? inventory.map(s=>`<tr>
        <td>${s.models||'—'}</td><td>${s.part||'—'}</td>
        <td>${s.desc||'—'}</td><td>${s.qty||1}</td>
        <td colspan="2">${s.supplier||'—'}</td>
      </tr>`).join('')
    : '<tr><td colspan="6" style="color:var(--muted);text-align:center;padding:12px;">Sin repuestos</td></tr>';
  openModal('stockEmailModal');
}

function sendStockEmail() {
  const to    = document.getElementById('stockEmailTo').value.trim();
  const fecha = new Date().toLocaleDateString('es');
  const hora  = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  let body = `STOCK DE REPUESTOS — ${appConfig.name||'IGNIS'}\nFecha: ${fecha} ${hora}\n${'─'.repeat(80)}\n\n`;
  body += `${'MODELO'.padEnd(12)}${'Nº PIEZA'.padEnd(14)}${'DESCRIPCIÓN'.padEnd(30)}${'CANT'.padEnd(6)}PROVEEDOR\n${'─'.repeat(80)}\n`;
  inventory.forEach(s => {
    body += `${(s.models||'—').padEnd(12)}${(s.part||'—').padEnd(14)}${(s.desc||'—').padEnd(30)}${String(s.qty||1).padEnd(6)}${s.supplier||'—'}\n`;
  });
  body += '\n── Generado con IGNIS ──';
  const subj = encodeURIComponent(`Stock Repuestos ECLIPSE TJ — ${fecha}`);
  window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subj}&body=${encodeURIComponent(body)}`;
  closeModal('stockEmailModal');
}



function persistStock() {
  localStorage.setItem('cb_stock', JSON.stringify(stockData));
}

function renderStockList() {
  const el = document.getElementById('stockGlobalList');
  const allBurners = burners.filter(b => stockData[b.id]?.length > 0);
  if (allBurners.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">📦</div>
      <div class="empty-text">Sin repuestos registrados.<br>Tocá ＋ para agregar.</div></div>`;
    return;
  }
  const zones = [...new Set(burners.map(b => b.zone))];
  let html = '';
  zones.forEach(zone => {
    const zb = burners.filter(b => b.zone===zone && stockData[b.id]?.length > 0);
    if (!zb.length) return;
    html += `<div class="zone-label">${zone}</div>`;
    zb.forEach(b => {
      const items = stockData[b.id] || [];
      html += `<div class="checklist-item" style="margin-bottom:10px;">
        <div class="ci-header">
          <div class="burner-id">${b.id}</div>
          <div style="margin-left:auto;font-size:11px;color:var(--muted);font-family:var(--font-m);">${b.model} · ${items.length} ítem${items.length!==1?'s':''}</div>
        </div>
        <div class="stock-table-wrap">
          <table class="stock-table">
            <thead><tr><th>Nº Pieza</th><th>Descripción</th><th>Cant</th><th>Marca</th><th>Proveedor</th><th></th></tr></thead>
            <tbody>${items.map((s,i)=>`<tr>
              <td>${s.part||'—'}</td><td>${s.desc||'—'}</td>
              <td>${s.qty||1}</td><td>${s.brand||'—'}</td><td>${s.supplier||'—'}</td>
              <td style="cursor:pointer;color:var(--danger);text-align:center;" onclick="deleteStockItem('${b.id}',${i})">✕</td>
            </tr>`).join('')}</tbody>
          </table>
        </div>
      </div>`;
    });
  });
  el.innerHTML = html;
}

function openAddStockScreen() {
  const sel = document.getElementById('stockBurnerSel');
  sel.innerHTML = burners.map(b =>
    `<option value="${b.id}">${b.id} — ${b.model} · ${b.zone}</option>`
  ).join('');
  ['sPartNum','sDesc','sQty','sBrand','sSupplier'].forEach(id => document.getElementById(id).value='');
  document.getElementById('stockView-list').style.display = 'none';
  document.getElementById('stockView-form').style.display = 'block';
}

function backToStockList() {
  document.getElementById('stockView-form').style.display = 'none';
  document.getElementById('stockView-list').style.display = 'block';
  renderStockList();
}

function saveStockItem() {
  const burnerId = document.getElementById('stockBurnerSel').value;
  const part     = document.getElementById('sPartNum').value.trim();
  const desc     = document.getElementById('sDesc').value.trim();
  const qty      = parseInt(document.getElementById('sQty').value)||1;
  const brand    = document.getElementById('sBrand').value.trim();
  const supplier = document.getElementById('sSupplier').value.trim();
  if (!part && !desc) { alert('Ingresá al menos Nº de pieza o descripción'); return; }
  if (!stockData[burnerId]) stockData[burnerId] = [];
  stockData[burnerId].push({part,desc,qty,brand,supplier});
  persistStock();
  backToStockList();
}

function deleteStockItem(burnerId, idx) {
  if (!confirm('¿Eliminar este repuesto?')) return;
  stockData[burnerId].splice(idx,1);
  if (!stockData[burnerId].length) delete stockData[burnerId];
  persistStock();
  renderStockList();
}



function openStockEmailModal() {
  const allItems = [];
  burners.forEach(b => { (stockData[b.id]||[]).forEach(s => allItems.push({burnerId:b.id,...s})); });
  const fecha = new Date().toLocaleDateString('es');
  document.getElementById('stockEmailSub').textContent =
    `${allItems.length} repuesto${allItems.length!==1?'s':''} registrado${allItems.length!==1?'s':''} · ${fecha}`;
  document.getElementById('stockEmailBody').innerHTML = allItems.length
    ? allItems.map(s=>`<tr><td>${s.burnerId}</td><td>${s.part||'—'}</td><td>${s.desc||'—'}</td><td>${s.qty||1}</td><td>${s.brand||'—'}</td><td>${s.supplier||'—'}</td></tr>`).join('')
    : '<tr><td colspan="6" style="color:var(--muted);text-align:center;padding:12px;">Sin repuestos</td></tr>';
  openModal('stockEmailModal');
}

function sendStockEmail() {
  const to    = document.getElementById('stockEmailTo').value.trim();
  const fecha = new Date().toLocaleDateString('es');
  const hora  = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  let body = `STOCK DE REPUESTOS — ${appConfig.name||'IGNIS'}\nFecha: ${fecha} ${hora}\n${'─'.repeat(80)}\n\n`;
  body += `${'QUEMADOR'.padEnd(14)}${'Nº PIEZA'.padEnd(12)}${'DESCRIPCIÓN'.padEnd(22)}${'CANT'.padEnd(6)}${'MARCA'.padEnd(12)}PROVEEDOR\n${'─'.repeat(80)}\n`;
  burners.forEach(b => {
    (stockData[b.id]||[]).forEach(s => {
      body += `${b.id.padEnd(14)}${(s.part||'—').padEnd(12)}${(s.desc||'—').padEnd(22)}${String(s.qty||1).padEnd(6)}${(s.brand||'—').padEnd(12)}${s.supplier||'—'}\n`;
    });
  });
  body += '\n── Generado con IGNIS ──';
  const subj = encodeURIComponent(`Stock Repuestos ECLIPSE TJ — ${fecha}`);
  window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subj}&body=${encodeURIComponent(body)}`;
  closeModal('stockEmailModal');
}

// ══════════════════════════════════
// QR GENERATOR
// ══════════════════════════════════
let qrInstance = null;

function openQRModal() {
  const sel = document.getElementById('qrBurnerSelect');
  sel.innerHTML = burners.map(b =>
    `<option value="${b.id}">${b.id} — ${b.model} · ${b.zone}</option>`
  ).join('');
  openModal('qrModal');
  setTimeout(renderQR, 150);
}

// 60mm × 50mm at 96dpi = 226 × 189 px (screen preview scale ×0.75 = 170 × 142)
const QR_W_PX = 170;  // preview canvas width
const QR_H_PX = 142;  // preview canvas height (50mm proportional)
const QR_SIZE = 116;  // QR code area within label

function renderQR() {
  const sel = document.getElementById('qrBurnerSelect');
  const id  = sel.value;
  if (!id) return;
  const b = burners.find(x => x.id === id);
  drawQRLabel(id, b, document.getElementById('qrCanvas'), QR_W_PX, QR_H_PX, QR_SIZE);
  document.getElementById('qrIdLabel').textContent   = id;
  document.getElementById('qrMetaLabel').textContent = `${b?.model||''} · ${b?.zone||''}`;
}

function drawQRLabel(id, b, canvas, W, H, qrSize, cb) {
  canvas.width  = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');

  // White background
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, W, H);

  // Border
  ctx.strokeStyle = '#333';
  ctx.lineWidth   = 1.5;
  ctx.strokeRect(1, 1, W-2, H-2);

  const qrX = (W - qrSize) / 2;
  const qrY = 6;

  if (typeof QRCode === 'undefined') {
    // QR lib not loaded — draw placeholder
    ctx.fillStyle = '#eee';
    ctx.fillRect(qrX, qrY, qrSize, qrSize);
    ctx.fillStyle = '#999';
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('QR (requiere', W/2, qrY + qrSize/2 - 6);
    ctx.fillText('conexión)', W/2, qrY + qrSize/2 + 8);
    drawLabelText(ctx, id, b, W, H, qrY + qrSize);
    if (cb) cb();
    return;
  }

  // Generate QR into temp div
  const tmp = document.createElement('div');
  if (qrInstance) { try { qrInstance.clear(); qrInstance = null; } catch(e){} }
  qrInstance = new QRCode(tmp, {
    text: `ignis://${id}?model=${b?.model||''}&zone=${encodeURIComponent(b?.zone||'')}`,
    width: qrSize, height: qrSize,
    colorDark: '#000000', colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  });

  setTimeout(() => {
    const img = tmp.querySelector('img') || tmp.querySelector('canvas');
    if (img) ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
    drawLabelText(ctx, id, b, W, H, qrY + qrSize);
    if (cb) cb();
  }, 250);
}

function drawLabelText(ctx, id, b, W, H, qrBottom) {
  // ID — big and bold
  ctx.textAlign  = 'center';
  ctx.fillStyle  = '#000';
  ctx.font       = `bold ${Math.round(W*0.085)}px monospace`;
  ctx.fillText(id, W/2, qrBottom + 14);
  // Model · Zone — small
  ctx.font      = `${Math.round(W*0.055)}px monospace`;
  ctx.fillStyle = '#444';
  ctx.fillText(`${b?.model||''} · ${b?.zone||''}`, W/2, qrBottom + 26);
}

function downloadQR() {
  const sel = document.getElementById('qrBurnerSelect');
  const id  = sel.value;
  if (!id) return;
  const b = burners.find(x => x.id === id);

  // Generate high-res version: 60mm×50mm @ 150dpi = 354×295px
  const hiCanvas = document.createElement('canvas');
  const HI_W = 354, HI_H = 295, HI_QR = 240;
  drawQRLabel(id, b, hiCanvas, HI_W, HI_H, HI_QR, () => {
    const link = document.createElement('a');
    link.download = `QR_${id}_60x50mm.png`;
    link.href = hiCanvas.toDataURL('image/png');
    link.click();
  });
}

function printAllQR() {
  // Build a print page with all burners in 60×50mm labels, 3 per row
  const HI_W = 354, HI_H = 295, HI_QR = 240;
  let generated = 0;
  const labelData = [];

  function generateNext(idx) {
    if (idx >= burners.length) {
      openPrintWindow(labelData);
      return;
    }
    const b = burners[idx];
    const c = document.createElement('canvas');
    drawQRLabel(b.id, b, c, HI_W, HI_H, HI_QR, () => {
      labelData.push({ id: b.id, src: c.toDataURL('image/png') });
      generateNext(idx + 1);
    });
  }

  if (typeof QRCode === 'undefined') {
    alert('📶 El generador de QR requiere conexión a internet. Conectate y recargá la página.');
    return;
  }
  generateNext(0);
}

function openPrintWindow(labels) {
  const rows = [];
  for (let i = 0; i < labels.length; i += 3) {
    const trio = labels.slice(i, i+3);
    rows.push(`<tr>${trio.map(l =>
      `<td style="padding:2mm;border:none;vertical-align:top;text-align:center;">
        <img src="${l.src}" style="width:60mm;height:50mm;display:block;">
      </td>`
    ).join('')}</tr>`);
  }

  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html>
<html><head><title>Etiquetas QR — ${appConfig.name||'IGNIS'}</title>
<style>
  @page { size: A4; margin: 10mm; }
  body { margin:0; font-family:monospace; }
  table { border-collapse:collapse; width:100%; }
  td { width:60mm; height:50mm; }
  img { width:60mm; height:50mm; }
  @media print { body { margin:0; } }
</style>
</head>
<body>
  <div style="font-size:9pt;color:#666;margin-bottom:4mm;font-family:monospace;">
    ${appConfig.name||'IGNIS'} · Etiquetas QR · ${new Date().toLocaleDateString('es')}
  </div>
  <table>${rows.join('')}</table>
  <script>// print handled by parent<\/script>
</body></html>`);
  win.document.close();
}





// ══════════════════════════════════
// QR SCANNER
// ══════════════════════════════════
let scannerStream = null;
let scannerAnimFrame = null;

function startScanner() {
  const video = document.getElementById('scannerVideo');
  const status = document.getElementById('scannerStatus');
  
  navigator.mediaDevices.getUserMedia({ 
    video: { facingMode: 'environment' } 
  }).then(stream => {
    scannerStream = stream;
    video.srcObject = stream;
    video.play();
    status.textContent = 'Buscando QR...';
    scanQRFrame();
  }).catch(err => {
    status.textContent = '❌ No se pudo acceder a la cámara';
    console.error(err);
  });
}

function scanQRFrame() {
  const video = document.getElementById('scannerVideo');
  const canvas = document.createElement('canvas');
  const status = document.getElementById('scannerStatus');
  
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    
    if (typeof jsQR === 'function') {
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code && code.data) {
        const match = code.data.match(/ignis:\/\/([^?]+)/);
        if (match) {
          const burnerId = match[1];
          status.textContent = '✅ QR detectado!';
          stopScanner();
          showBurnerInfo(burnerId);
          return;
        }
      }
    }
  }
  
  scannerAnimFrame = requestAnimationFrame(scanQRFrame);
}

function stopScanner() {
  if (scannerStream) {
    scannerStream.getTracks().forEach(t => t.stop());
    scannerStream = null;
  }
  if (scannerAnimFrame) {
    cancelAnimationFrame(scannerAnimFrame);
    scannerAnimFrame = null;
  }
  const video = document.getElementById('scannerVideo');
  video.srcObject = null;
}

function showBurnerInfo(burnerId) {
  const b = burners.find(x => x.id === burnerId);
  if (!b) {
    alert('Quemador no encontrado: ' + burnerId);
    goTo('scanScreen');
    return;
  }
  
  document.getElementById('biTitle').textContent = b.id;
  document.getElementById('biSub').textContent = `${b.model} · ${b.zone}`;
  
  // FIX: history guarda como 'id' no 'burnerId'
  const lastCalib = history
    .filter(h => h.id === b.id || h.burnerId === b.id)
    .sort((a,c) => new Date(c.date + ' ' + (c.ts||'')) - new Date(a.date + ' ' + (a.ts||'')))[0];
  const calibStatus = lastCalib ? (lastCalib.diag || 'CALIBRADO') : 'Sin calibrar';
  const calibDate = lastCalib ? (lastCalib.date + (lastCalib.ts ? ' ' + lastCalib.ts : '')) : '—';
  const calibUser = lastCalib?.user || window._currentUser?.nombre || '—';
  
  // Último mantenimiento — items son directamente las keys del objeto (boquilla, cono, etc.)
  const maintInfo = maintData[b.id];
  const maintDate = maintInfo?.fecha || maintInfo?.date || '—';
  const _maintItems = maintInfo ? Object.entries(maintInfo).filter(([k,v]) => typeof v === 'object' && v !== null && v.status && v.status !== 'ok') : [];
  const _maintAll  = maintInfo ? Object.entries(maintInfo).filter(([k,v]) => typeof v === 'object' && v !== null && v.status) : [];
  const maintItems = _maintItems.length;
  const maintTotal = _maintAll.length;
  const maintPct = maintTotal > 0 ? Math.round((maintTotal - maintItems) / maintTotal * 100) : 0;
  const maintPhoto = maintPhotos[b.id];
  
  // Stock separado: específicos del modelo y TODOS
  const matchModel = s => {
    if (!s.models) return false;
    if (Array.isArray(s.models)) return s.models.includes(b.model);
    return s.models === b.model;
  };
  const matchTodos = s => {
    if (!s.models) return false;
    if (Array.isArray(s.models)) return s.models.includes('TODOS');
    return s.models === 'TODOS';
  };
  const stockEspecificos = inventory.filter(matchModel);
  const stockTodos = inventory.filter(matchTodos);
  const stockEspCount = stockEspecificos.reduce((sum, s) => sum + (s.qty || 0), 0);
  const stockTodosCount = stockTodos.reduce((sum, s) => sum + (s.qty || 0), 0);

  const stockEspHtml = stockEspecificos.length > 0
    ? stockEspecificos.map(s => `<div style="font-size:11px;color:var(--muted2);font-family:var(--font-m);margin-top:3px;">• ${s.desc||s.part} — <b style="color:var(--warn)">${s.qty||0} pzs</b></div>`).join('')
    : `<div style="font-size:11px;color:var(--muted);font-family:var(--font-m);margin-top:3px;">Sin repuestos específicos en stock</div>`;

  const stockTodosHtml = stockTodos.length > 0
    ? stockTodos.map(s => `<div style="font-size:11px;color:var(--muted2);font-family:var(--font-m);margin-top:3px;">• ${s.desc||s.part} — <b style="color:var(--muted2)">${s.qty||0} pzs</b></div>`).join('')
    : '';

  // Badge de calibración con color correcto
  const calibClass = lastCalib
    ? (lastCalib.diagClass === 'diag-ok' ? 'rgba(0,230,118,0.12);color:var(--ok)'
      : lastCalib.diagClass === 'diag-stoic' ? 'rgba(68,138,255,0.12);color:var(--blue)'
      : lastCalib.diagClass === 'diag-excess' ? 'rgba(255,171,0,0.12);color:var(--warn)'
      : 'rgba(255,61,61,0.12);color:var(--danger)') : 'rgba(90,96,112,0.12);color:var(--muted)';
  const maintClass = maintTotal > 0
    ? (maintPct === 100 ? 'rgba(0,230,118,0.12);color:var(--ok)'
      : maintPct >= 70  ? 'rgba(68,138,255,0.12);color:var(--blue)'
      : maintPct >= 40  ? 'rgba(255,171,0,0.12);color:var(--warn)'
      : 'rgba(255,61,61,0.12);color:var(--danger)') : 'rgba(68,138,255,0.12);color:var(--blue)';

  // Stock items HTML — igual a mini app
  const stockEspItemsHtml = stockEspecificos.length > 0
    ? stockEspecificos.map(s => `<div style="font-size:12px;color:var(--text);font-family:var(--font-m);padding:6px 0;border-top:1px solid var(--border);display:flex;justify-content:space-between;"><span>${s.desc||s.part}</span><span style="font-weight:700;color:var(--warn);">${s.qty||0} pzs</span></div>`).join('')
    : '<div style="font-size:12px;color:var(--muted);font-family:var(--font-m);padding:6px 0;border-top:1px solid var(--border);">Sin repuestos específicos en stock</div>';
  const stockTodosItemsHtml = stockTodos.map(s =>
    `<div style="font-size:12px;color:var(--text);font-family:var(--font-m);padding:6px 0;border-top:1px solid var(--border);display:flex;justify-content:space-between;"><span>${s.desc||s.part}</span><span style="font-weight:700;color:var(--warn);">${s.qty||0} pzs</span></div>`
  ).join('');

  const body = document.getElementById('biBody');
  body.innerHTML = `
    <div class="burner-card" style="--bc:var(--ok);gap:8px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="font-size:22px;min-width:28px;">🔥</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;color:var(--text);">Última Calibración</div>
          <div style="font-size:12px;color:var(--text);font-family:var(--font-m);margin-top:2px;">${calibDate}</div>
        </div>
        <div style="padding:5px 12px;background:${calibClass};border-radius:8px;font-size:12px;font-weight:700;font-family:var(--font-m);">${calibStatus}</div>
      </div>
      ${lastCalib ? '<div style="font-size:11px;color:var(--muted);font-family:var(--font-m);margin-top:6px;">Técnico: ' + calibUser + '</div>' : ''}
    </div>

    <div class="burner-card" style="--bc:var(--blue);gap:8px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="font-size:22px;min-width:28px;">🔧</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;color:var(--text);">Último Mantenimiento</div>
          <div style="font-size:12px;color:var(--text);font-family:var(--font-m);margin-top:2px;">${maintDate}</div>
        </div>
        <div style="padding:5px 12px;background:${maintClass};border-radius:8px;font-size:12px;font-weight:700;font-family:var(--font-m);">${maintPct}%</div>
      </div>
      ${maintInfo ? '<div style="font-size:11px;color:var(--muted);font-family:var(--font-m);margin-top:6px;">Items afectados: ' + maintItems + ' de ' + maintTotal + '</div>' : ''}
      ${maintPhoto ? '<img src="' + maintPhoto.data + '" style="width:100%;height:120px;object-fit:cover;border-radius:10px;margin-top:8px;">' : ''}
    </div>

    <div class="burner-card" style="--bc:var(--warn);gap:8px;flex-direction:column;align-items:flex-start;">
      <div style="display:flex;align-items:center;gap:12px;width:100%;cursor:pointer;" onclick="var p=document.getElementById('esp_${b.id}');var arr=document.getElementById('arr_esp_${b.id}');p.style.display=p.style.display==='none'?'block':'none';arr.textContent=p.style.display==='none'?'▾':'▴'">
        <div style="font-size:22px;min-width:28px;">📦</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;color:var(--text);">Repuestos</div>
          <div style="font-size:12px;color:var(--text);font-family:var(--font-m);">${b.model}</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <div style="padding:5px 12px;background:rgba(255,171,0,0.12);color:var(--warn);border-radius:8px;font-size:12px;font-weight:700;font-family:var(--font-m);">${stockEspCount} pzs</div>
          <div id="arr_esp_${b.id}" style="color:var(--warn);font-size:14px;">▾</div>
        </div>
      </div>
      <div id="esp_${b.id}" style="display:none;width:100%;margin-top:4px;">${stockEspItemsHtml}</div>
    </div>
  `;

  if (stockTodos.length > 0) {
    const panelId = 'tp_' + b.id;
    const todosCard = document.createElement('div');
    todosCard.className = 'burner-card';
    todosCard.style.cssText = '--bc:var(--warn);gap:8px;flex-direction:column;align-items:flex-start;';
    todosCard.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;width:100%;cursor:pointer;" onclick="var p=document.getElementById('${panelId}');var arr=document.getElementById('arr_${panelId}');p.style.display=p.style.display==='none'?'block':'none';arr.textContent=p.style.display==='none'?'▾':'▴'">
        <div style="font-size:22px;min-width:28px;">📦</div>
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:700;color:var(--text);">Repuestos</div>
          <div style="font-size:12px;color:var(--text);font-family:var(--font-m);">Todos los modelos</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <div style="padding:5px 12px;background:rgba(255,171,0,0.12);color:var(--warn);border-radius:8px;font-size:12px;font-weight:700;font-family:var(--font-m);">${stockTodosCount} pzs</div>
          <div id="arr_${panelId}" style="color:var(--warn);font-size:14px;">▾</div>
        </div>
      </div>
      <div id="${panelId}" style="display:none;width:100%;margin-top:4px;">${stockTodosItemsHtml}</div>
    `;
    body.appendChild(todosCard);
  }

  const pie = document.createElement('div');
  pie.style.cssText = 'font-size:10px;color:var(--muted);font-family:var(--font-m);text-align:center;margin-top:8px;padding-bottom:8px;';
  pie.textContent = 'Escaneado por ' + (window._currentUser?.nombre || 'Usuario') + ' · ' + new Date().toLocaleString('es', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
  body.appendChild(pie);

  goTo('burnerInfoScreen');
}

applyConfig();
</script>

<!-- Librerías opcionales: PDF y QR (requieren internet) -->
<script>
function loadScript(src, cb) {
  const s = document.createElement('script');
  s.src = src; s.async = true;
  s.onload = cb || function(){};
  s.onerror = function(){ console.warn('No se pudo cargar:', src); };
  document.head.appendChild(s);
}
loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
loadScript('https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js');
loadScript('https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js');

// Safe wrappers — si la lib no cargó, muestra aviso amigable
const _generateCalibPDF = generateCalibPDF;
const _generateMaintPDF = generateMaintPDF;
const _openQRModal      = openQRModal;

window.generateCalibPDF = function() {
  if (!window.jspdf) { alert('📶 PDF requiere conexión a internet la primera vez. Conectate y recargá la página.'); return; }
  _generateCalibPDF();
};
window.generateMaintPDF = function() {
  if (!window.jspdf) { alert('📶 PDF requiere conexión a internet la primera vez. Conectate y recargá la página.'); return; }
  _generateMaintPDF();
};
window.openQRModal = function() {
  if (typeof QRCode === 'undefined') { alert('📶 QR requiere conexión a internet la primera vez. Conectate y recargá la página.'); return; }
  _openQRModal();
};
</script>
</body>
</html>
